<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Äá»c Dá»… â€“ Há»— trá»£ tráº» rá»‘i loáº¡n Ä‘á»c</title>
  <meta name="description" content="Luyá»‡n Ã¢m vá»‹, tháº» tá»«, Ä‘á»c trÃ´i cháº£y (WCPM), hiá»ƒu; Voice UI, thÆ°á»›c dÃ²ng, tÃ¹y biáº¿n dá»… Ä‘á»c, Ä‘á»“ng bá»™ Google Drive." />
  <link rel="manifest" href="manifest.webmanifest">
  <meta name="theme-color" content="#FFF3D6" />
  <link rel="icon" href="data:image/svg+xml;utf8,
  <svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 128 128'>
    <rect width='128' height='128' fill='%23FFF3D6'/>
    <text x='50%' y='58%' dominant-baseline='middle' text-anchor='middle' font-size='80' font-family='sans-serif' fill='%23111'>Ä</text>
  </svg>">

  <style>
    :root{
      /* Chá»§ Ä‘á» Calm máº·c Ä‘á»‹nh */
      --bg: #FFF3D6;        /* ná»n vÃ ng nháº¡t, giáº£m chÃ³i */
      --panel: #FFF8E6;     /* panel áº¥m */
      --text: #111111;
      --muted: #555;
      --primary: #2E7D32;   /* Ä‘Ãºng/tiáº¿p tá»¥c */
      --danger: #C62828;    /* sai/dá»«ng */
      --hint: #FFB300;      /* gá»£i Ã½/hÆ°á»›ng dáº«n */
      --tts: #6A1B9A;       /* TTS */
      --record: #1565C0;    /* ghi Ã¢m */
      --border: #E2C995;
      --card: #FFFDF6;
      --accent: #4ECDC4;

      /* Tham sá»‘ dá»… Ä‘á»c (cÃ³ thá»ƒ chá»‰nh) */
      --fs: 18px;          /* cá»¡ chá»¯ cÆ¡ sá»Ÿ */
      --lh: 1.75;          /* giÃ£n dÃ²ng */
      --ls: 0.02em;        /* giÃ£n chá»¯ */
      --ruler-h: 2.4em;    /* chiá»u cao thÆ°á»›c dÃ²ng */
      --anim: 1;           /* 1: cÃ³ chuyá»ƒn Ä‘á»™ng nháº¹; 0: táº¯t chuyá»ƒn Ä‘á»™ng */

      --font-body: "Lexend", "OpenDyslexic", "Noto Sans", "Be Vietnam Pro", system-ui, -apple-system, Segoe UI, Roboto, Arial, "Helvetica Neue", sans-serif;

      --radius: 16px;
      --shadow: 0 8px 30px rgba(0,0,0,0.10);
      --shadow-soft: 0 6px 18px rgba(0,0,0,0.08);
      --focus: 3px solid #4ECDC4;
    }

    /* Theme Vivid */
    body.theme-vivid {
      --bg: #FFF1CC;
      --panel: #FFF6DE;
      --accent: #FF7F50; /* coral */
      --primary: #2B7A0B;
      --tts: #6F2DBD;
      --record: #0077B6;
    }
    /* Theme High Contrast */
    body.theme-contrast {
      --bg: #FFFFFF;
      --panel: #FFFFFF;
      --text: #000000;
      --muted: #111;
      --border: #111;
      --card: #FFFFFF;
      --accent: #000;
    }

    html, body {
      background:
        radial-gradient(1200px 600px at 10% -10%, #FFF8E6, transparent),
        radial-gradient(800px 500px at 100% 0%, #FFF9EB, transparent),
        var(--bg);
      color: var(--text);
      font-family: var(--font-body);
      font-size: var(--fs);
      line-height: var(--lh);
      letter-spacing: var(--ls);
      margin: 0; padding: 0;
      -webkit-font-smoothing: antialiased;
      text-rendering: optimizeLegibility;
      transition: background-color calc(var(--anim)*180ms) ease, color calc(var(--anim)*180ms) ease;
    }

    .app { max-width: 980px; margin: 0 auto; padding: 12px 12px 90px; }

    header.appbar {
      position: sticky; top: env(safe-area-inset-top, 0);
      background: rgba(255, 243, 214, 0.8); backdrop-filter: blur(10px);
      display: flex; align-items: center; justify-content: space-between; gap: 8px;
      padding: 12px; z-index: 50; border-bottom: 1px solid var(--border);
      border-radius: 0 0 18px 18px;
    }
    .title { font-weight: 900; font-size: 22px; letter-spacing: 0.01em; display:flex; align-items:center; gap:8px;}
    .subtitle { color: var(--muted); font-size: 12px; }

    .toolbar { display: flex; gap: 6px; align-items: center; flex-wrap: wrap; }
    .badge { background: #fff; border: 1px solid var(--border); padding: 6px 10px; border-radius: 999px; font-size: 12px; }

    button {
      font: inherit; border: none; border-radius: 14px; padding: 12px 16px;
      background: linear-gradient(180deg, #ffffff, #fff8ec);
      box-shadow: var(--shadow-soft); cursor: pointer; transition: transform calc(var(--anim)*60ms) ease, box-shadow calc(var(--anim)*120ms) ease;
    }
    @media (pointer:fine){
      button:hover { transform: translateY(-1px) scale(1.01); box-shadow: var(--shadow); }
    }
    button:active { transform: translateY(1px); }
    button:focus-visible { outline: var(--focus); outline-offset: 2px; }
    button.primary { background: linear-gradient(180deg, var(--primary), #1e5c23); color: #fff; }
    button.danger { background: linear-gradient(180deg, var(--danger), #8e1d1d); color: #fff; }
    button.hint { background: linear-gradient(180deg, var(--hint), #d99700); color: #111; }
    button.ghost { background: transparent; box-shadow: none; border: 1px solid var(--border); }
    button.tts { background: linear-gradient(180deg, var(--tts), #4a116d); color: #fff; }
    button.record { background: linear-gradient(180deg, var(--record), #0f4c90); color: #fff; }
    button.tog { background: #fff; border: 1px solid var(--border); }

    .home-grid { display: grid; grid-template-columns: repeat(2, minmax(0,1fr)); gap: 16px; margin: 12px 0 0; }
    @media (max-width:680px){ .home-grid{ grid-template-columns: 1fr; } }

    .card {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 16px;
      box-shadow: var(--shadow-soft);
      transition: transform calc(var(--anim)*100ms) ease, box-shadow calc(var(--anim)*160ms) ease;
    }
    @media (pointer:fine){
      .card:hover { transform: translateY(-2px); box-shadow: var(--shadow); }
    }
    .card h3 { margin: 0 0 8px 0; font-size: 18px; display:flex; align-items:center; gap:8px;}
    .note { font-size: 13px; color: var(--muted); }

    .screen { display: none; }
    .screen.active { display: block; }

    .section {
      background: #fff; border: 1px solid var(--border); border-radius: var(--radius);
      padding: 16px; margin: 12px 0; box-shadow: var(--shadow-soft);
    }

    .row { display:flex; gap:10px; align-items:center; flex-wrap: wrap; }
    .spacer { flex: 1; }
    .muted { color: var(--muted); }

    .chip {
      background: #fff; border: 1px dashed #e0c78f; padding: 10px 12px; border-radius: 12px; min-width: 40px; text-align: center; font-weight: 700; box-shadow: var(--shadow-soft); user-select: none;
    }

    .dropzone {
      display: flex; gap: 8px; flex-wrap: wrap; padding: 10px; min-height: 52px; background: var(--card); border-radius: 12px; border: 2px dashed #e9d9b5;
    }

    .big-text { font-size: clamp(22px, 5vw, 36px); line-height: 1.7; }

    .token { display:inline-block; padding:2px 4px; border-radius: 6px; margin: 1px 1px; transition: background-color calc(var(--anim)*120ms) ease, transform calc(var(--anim)*80ms) ease; }
    .token:focus-visible { outline: var(--focus); }

    /* MÃ u theo thanh Ä‘iá»‡u (nháº¥t quÃ¡n) */
    .tone-ngang { background: #E1F5FE; }
    .tone-sáº¯c  { background: #FCE4EC; }
    .tone-huyá»n{ background: #E8F5E9; }
    .tone-há»i  { background: #FFF8E1; }
    .tone-ngÃ£  { background: #EDE7F6; }
    .tone-náº·ng { background: #F3E5F5; }

    .inline-buttons { display:flex; gap:8px; flex-wrap: wrap; margin-top:8px; }

    .stat { background:#fff; border-radius:10px; padding:8px 10px; border:1px solid var(--border); display:inline-flex; align-items:center; gap:8px; margin:4px 8px 4px 0; }

    .grid-2 { display:grid; grid-template-columns: repeat(2, minmax(0,1fr)); gap:10px; }
    @media (max-width: 720px){ .grid-2{ grid-template-columns: 1fr; } }

    .question { background:#fff; border:1px solid var(--border); padding:10px; border-radius:10px; margin:8px 0; }

    canvas { max-width: 100%; background:#fff; border:1px solid var(--border); border-radius: 10px; }

    .footerbar {
      position: fixed; bottom: 0; left: 0; right: 0; background: rgba(255,243,214,0.85); border-top:1px solid var(--border);
      display:flex; gap:10px; justify-content:center; padding:10px; backdrop-filter: blur(6px);
    }

    .help { font-size: 13px; color: var(--muted); background:#fff; padding:10px; border:1px solid var(--border); border-radius:10px; }

    .modal { position: fixed; inset: 0; display:none; place-items:center; background: rgba(0,0,0,0.25); padding: 10px; z-index: 1000; }
    .modal.active{ display:grid; }
    .modal > .dialog { max-width: 560px; width: 100%; background: var(--panel); border:1px solid var(--border); border-radius:18px; padding:16px; box-shadow: var(--shadow); }

    input[type="text"], input[type="number"], input[type="url"], select, input[type="range"] {
      font: inherit; padding:10px 12px; border-radius:10px; border:1px solid var(--border); background:#fff; width:100%;
    }
    label { font-size: 13px; color: var(--muted); display:block; margin: 8px 0 4px; }

    .level-pill { background:#fff; border:1px solid var(--border); padding: 6px 10px; border-radius: 999px; }
    .stars { font-size: 18px; }

    /* Child mode: Ä‘Æ¡n giáº£n hÃ³a giao diá»‡n, áº©n thanh footer */
    body.child .footerbar { display: none; }
    body.child .toolbar .setup-only { display: none !important; }

    /* Há»™p khÃ³a cháº¿ Ä‘á»™ tá»± há»c */
    .lockbar {
      position: fixed; right: 10px; bottom: 80px; z-index: 999;
      display: inline-flex; align-items:center; gap: 8px;
      background:#fff; border:1px solid var(--border); padding:10px 12px; border-radius: 999px; box-shadow: var(--shadow-soft);
    }

    /* Thanh tá»‘c Ä‘á»™ TTS */
    .slider {
      display:flex; align-items:center; gap:8px; padding:6px 10px; background:#fff; border:1px solid var(--border); border-radius: 999px;
    }
    .slider input[type="range"]{ width: 160px; }

    /* Äáº¿ Ä‘iá»u khiá»ƒn ná»•i (Quick Dock) */
    .dock {
      position: fixed; right: 10px; bottom: 10px; z-index: 1200;
      display: grid; gap: 8px; grid-auto-flow: row;
    }
    .dock button {
      padding: 10px 12px; min-width: 46px;
      background: #fff; border: 1px solid var(--border); border-radius: 12px; box-shadow: var(--shadow-soft);
    }

    /* ThÆ°á»›c dÃ²ng trong Ä‘oáº¡n Ä‘á»c */
    #passageView { position: relative; }
    .ruler {
      position: absolute; left: -6px; right: -6px; height: var(--ruler-h);
      background: rgba(255, 215, 64, 0.28);
      border: 2px solid #F5C542; border-radius: 10px;
      display: none; pointer-events: none;
      transition: transform calc(var(--anim)*120ms) ease;
    }

    /* Confetti nháº¹ khi thÆ°á»Ÿng sao */
    .confetti {
      position: fixed; z-index: 2000; pointer-events: none; font-size: 18px;
      animation: fall linear forwards;
    }
    @keyframes fall {
      0% { transform: translateY(-10vh) rotate(0deg); opacity: 1; }
      100% { transform: translateY(110vh) rotate(360deg); opacity: 0; }
    }

    /* Giáº£m chuyá»ƒn Ä‘á»™ng */
    body.no-motion * {
      transition: none !important;
      animation: none !important;
    }
  </style>
</head>
<body>
<div class="app">
  <header class="appbar">
    <div>
      <div class="title">Äá»c Dá»… <span class="stars" id="starCount">â­ 0</span></div>
      <div class="subtitle">Ã‚m vá»‹ â€¢ Tháº» tá»« â€¢ Äá»c trÃ´i cháº£y â€¢ Dashboard</div>
    </div>
    <div class="toolbar">
      <span id="learnerBadge" class="badge">ChÆ°a thiáº¿t láº­p</span>
      <button class="tog" id="btnChild" data-voice="Báº­t hoáº·c táº¯t cháº¿ Ä‘á»™ tá»± há»c">ğŸš¸ Tá»± há»c: Táº¯t</button>
      <button class="tog" id="btnVoice" data-voice="Báº­t hoáº·c táº¯t giá»ng nÃ³i trá»£ giÃºp">ğŸ”Š Giá»ng nÃ³i: Báº­t</button>
      <button class="ghost setup-only" id="btnSettings" data-voice="CÃ i Ä‘áº·t">CÃ i Ä‘áº·t</button>
      <button class="ghost" id="btnHelp" data-voice="HÆ°á»›ng dáº«n">HÆ°á»›ng dáº«n</button>
    </div>
  </header>

  <!-- HOME -->
  <section id="screen-home" class="screen active">
    <div class="home-grid">
      <div class="card">
        <h3>ğŸ¯ Luyá»‡n Ã¢m vá»‹</h3>
        <div class="note">KÃ©oâ€‘tháº£ Ã¢m/tiáº¿ng, thanh Ä‘iá»‡u, cáº·p tá»‘i thiá»ƒu.</div>
        <div class="inline-buttons" style="margin-top:10px;">
          <button class="primary" onclick="App.nav('pa')" data-voice="Luyá»‡n Ã¢m vá»‹. Báº¯t Ä‘áº§u">Báº¯t Ä‘áº§u</button>
          <button class="tts" onclick="App.speak('Luyá»‡n Ã¢m vá»‹')" data-voice="Nghe hÆ°á»›ng dáº«n Luyá»‡n Ã¢m vá»‹">ğŸ”Š Nghe</button>
        </div>
      </div>

      <div class="card">
        <h3>ğŸƒ Tháº» tá»«</h3>
        <div class="note">Nháº­n diá»‡n tá»« theo láº·p láº¡i giÃ£n cÃ¡ch.</div>
        <div class="inline-buttons" style="margin-top:10px;">
          <button class="primary" onclick="App.nav('cards')" data-voice="Tháº» tá»«. Ã”n táº­p">Ã”n táº­p</button>
        </div>
      </div>

      <div class="card">
        <h3>ğŸ“– Äá»c Ä‘oáº¡n</h3>
        <div class="note">Äo WCPM, % Ä‘Ãºng, hiá»ƒu ná»™i dung; ghi Ã¢m â€“ nghe láº¡i.</div>
        <div class="inline-buttons" style="margin-top:10px;">
          <button class="primary" onclick="App.nav('reading')" data-voice="Äá»c Ä‘oáº¡n. Luyá»‡n Ä‘á»c">Luyá»‡n Ä‘á»c</button>
        </div>
      </div>

      <div class="card">
        <h3>ğŸ“Š Dashboard</h3>
        <div class="note">Biá»ƒu Ä‘á»“ tiáº¿n bá»™, lá»—i theo loáº¡i, xuáº¥t CSV, Ä‘á»“ng bá»™.</div>
        <div class="inline-buttons" style="margin-top:10px;">
          <button class="primary" onclick="App.nav('dashboard')" data-voice="Má»Ÿ báº£ng Ä‘iá»u khiá»ƒn">Má»Ÿ Dashboard</button>
        </div>
      </div>
    </div>

    <div class="section">
      <div class="row">
        <div class="level-pill">Gá»£i Ã½ cáº¥p Ä‘á»™ Ä‘á»c tiáº¿p theo: <b id="nextLevelHint">â€”</b></div>
        <div class="spacer"></div>
        <button onclick="App.nav('export')" data-voice="Xuáº¥t dá»¯ liá»‡u">Xuáº¥t dá»¯ liá»‡u</button>
      </div>
    </div>
  </section>

  <!-- PA -->
  <section id="screen-pa" class="screen">
    <div class="row">
      <button onclick="App.nav('home')" data-voice="Vá» trang chÃ­nh">â† Vá» trang chÃ­nh</button>
      <div class="spacer"></div>
      <span class="badge">Ã‚m vá»‹ há»c</span>
    </div>
    <div class="section" id="pa-container"></div>
    <div class="help">Máº¹o: Nháº¥n â€œğŸ”Šâ€ Ä‘á»ƒ nghe máº«u; kÃ©oâ€‘tháº£ â€œháº¡t Ã¢m/tiáº¿ngâ€ Ä‘á»ƒ rÃ¡p tá»«; hoáº·c chá»n thanh Ä‘iá»‡u/cáº·p tá»‘i thiá»ƒu theo yÃªu cáº§u.</div>
  </section>

  <!-- Cards -->
  <section id="screen-cards" class="screen">
    <div class="row">
      <button onclick="App.nav('home')" data-voice="Vá» trang chÃ­nh">â† Vá» trang chÃ­nh</button>
      <div class="spacer"></div>
      <span class="badge">Tháº» tá»«</span>
    </div>
    <div class="section" id="cards-container"></div>
    <div class="help">ÄÃ¡nh giÃ¡ â€œDá»…/Vá»«a/KhÃ³â€ Ä‘á»ƒ á»©ng dá»¥ng tá»± Ä‘á»™ng háº¹n ngÃ y Ã´n.</div>
  </section>

  <!-- Reading -->
  <section id="screen-reading" class="screen">
    <div class="row">
      <button onclick="App.nav('home')" data-voice="Vá» trang chÃ­nh">â† Vá» trang chÃ­nh</button>
      <div class="spacer"></div>
      <span class="badge">Äá»c Ä‘oáº¡n</span>
    </div>

    <div class="section">
      <div class="row">
        <label for="selLevel" style="margin:0;">Cáº¥p Ä‘á»™:</label>
        <select id="selLevel" onchange="App.reading.chooseLevel(this.value)" aria-label="Chá»n cáº¥p Ä‘á»™"></select>
        <div class="spacer"></div>
        <div class="slider" data-voice="Äiá»u chá»‰nh tá»‘c Ä‘á»™ giá»ng Ä‘á»c">
          <span>ğŸ”Š Tá»‘c Ä‘á»™</span>
          <input id="rateSlider" type="range" min="0.6" max="1.4" step="0.05" value="0.9"
                 oninput="App.updateRateFromSlider(this.value)" onfocus="VoiceUI.speak('Thanh tá»‘c Ä‘á»™ giá»ng Ä‘á»c')" />
          <span id="rateVal">0.90x</span>
        </div>
        <button class="ghost" onclick="App.reading.toggleFocus()" id="btnFocus" data-voice="Báº­t táº¯t cháº¿ Ä‘á»™ má»™t dÃ²ng">Cháº¿ Ä‘á»™ 1 dÃ²ng: Táº¯t</button>
        <button class="ghost" onclick="App.reading.toggleRuler()" id="btnRuler" data-voice="Báº­t táº¯t thÆ°á»›c dÃ²ng">ThÆ°á»›c dÃ²ng: Táº¯t</button>
        <button class="ghost" onclick="App.reading.moveRuler(-1)" id="btnRulerUp" data-voice="Di chuyá»ƒn thÆ°á»›c dÃ²ng lÃªn">â–²</button>
        <button class="ghost" onclick="App.reading.moveRuler(1)" id="btnRulerDown" data-voice="Di chuyá»ƒn thÆ°á»›c dÃ²ng xuá»‘ng">â–¼</button>
      </div>
    </div>

    <div class="section">
      <div id="passageView" class="big-text"></div>
      <div class="inline-buttons">
        <button class="hint" onclick="App.reading.markMode('error')" id="btnErr" data-voice="Cháº¿ Ä‘á»™ Ä‘Ã¡nh dáº¥u lá»—i">ÄÃ¡nh dáº¥u lá»—i</button>
        <button class="ghost" onclick="App.reading.markMode('normal')" id="btnNorm" data-voice="Cháº¿ Ä‘á»™ bÃ¬nh thÆ°á»ng">Cháº¿ Ä‘á»™ bÃ¬nh thÆ°á»ng</button>
      </div>
      <div class="help">Cháº¡m vÃ o tá»« Ä‘á»ƒ Ä‘Ã¡nh dáº¥u lá»—i; cháº¡m láº¡i Ä‘á»ƒ bá». Nháº¥n giá»¯ nÃºt Ä‘á»ƒ nghe tÃªn chá»©c nÄƒng. Cháº¡m vÃ¹ng trá»‘ng trong Ä‘oáº¡n Ä‘á»ƒ Ä‘áº·t thÆ°á»›c dÃ²ng.</div>
    </div>

    <div id="compSection" class="section" style="display:none;">
      <h3>CÃ¢u há»i hiá»ƒu ná»™i dung</h3>
      <div id="questions"></div>
      <div class="row" style="margin-top:8px;">
        <div class="spacer"></div>
        <button class="primary" onclick="App.reading.finishComp()" data-voice="HoÃ n táº¥t cÃ¢u há»i">HoÃ n táº¥t</button>
      </div>
    </div>
  </section>

  <!-- Dashboard -->
  <section id="screen-dashboard" class="screen">
    <div class="row">
      <button onclick="App.nav('home')" data-voice="Vá» trang chÃ­nh">â† Vá» trang chÃ­nh</button>
      <div class="spacer"></div>
      <span class="badge">Dashboard</span>
    </div>

    <div class="grid-2">
      <div class="section">
        <h3>WCPM theo thá»i gian</h3>
        <canvas id="chartWCPM" width="600" height="260"></canvas>
      </div>
      <div class="section">
        <h3>% chÃ­nh xÃ¡c theo thá»i gian</h3>
        <canvas id="chartACC" width="600" height="260"></canvas>
      </div>
      <div class="section">
        <h3>Tá»•ng lá»—i theo loáº¡i</h3>
        <canvas id="chartERR" width="600" height="260"></canvas>
      </div>
      <div class="section">
        <h3>Thá»i lÆ°á»£ng luyá»‡n táº­p</h3>
        <canvas id="chartDUR" width="600" height="260"></canvas>
      </div>
    </div>

    <div class="section">
      <div class="row">
        <button onclick="App.exportCSV()" data-voice="Táº£i tá»‡p CSV">Táº£i CSV</button>
        <button class="ghost" onclick="App.copyCSV()" data-voice="Sao chÃ©p CSV">Sao chÃ©p CSV</button>
        <div class="spacer"></div>
        <button class="danger" onclick="App.resetConfirm()" data-voice="XÃ³a dá»¯ liá»‡u trÃªn thiáº¿t bá»‹ nÃ y">XÃ³a dá»¯ liá»‡u (thiáº¿t bá»‹ nÃ y)</button>
      </div>
      <div class="help">CSV má»Ÿ báº±ng Excel/Google Sheets. Dá»¯ liá»‡u chá»‰ lÆ°u trÃªn thiáº¿t bá»‹ nÃ y trá»« khi báº¡n báº­t Äá»“ng bá»™.</div>
    </div>

    <div class="section">
      <h3>Äá»“ng bá»™ Google Drive</h3>
      <div class="row">
        <div class="spacer"></div>
        <span class="badge" id="syncStatus">Tráº¡ng thÃ¡i: chÆ°a cáº¥u hÃ¬nh</span>
      </div>
      <div class="inline-buttons" style="margin-top:10px;">
        <button onclick="Sync.flush()" data-voice="Äá»“ng bá»™ dá»¯ liá»‡u ngay">Äá»“ng bá»™ ngay</button>
        <button class="ghost" onclick="App.testSync()" data-voice="Kiá»ƒm tra káº¿t ná»‘i Ä‘á»“ng bá»™">Kiá»ƒm tra káº¿t ná»‘i</button>
        <button class="ghost" onclick="App.showSyncHelp()" data-voice="HÆ°á»›ng dáº«n thiáº¿t láº­p Ä‘á»“ng bá»™">HÆ°á»›ng dáº«n thiáº¿t láº­p</button>
      </div>
      <div class="help">á»¨ng dá»¥ng gá»­i log Ä‘á»c (WCPM, % Ä‘Ãºng, lá»—i, hiá»ƒu) tá»›i Apps Script, rá»“i lÆ°u vÃ o Google Drive cá»§a báº¡n.</div>
    </div>
  </section>

  <!-- Export -->
  <section id="screen-export" class="screen">
    <div class="row">
      <button onclick="App.nav('home')" data-voice="Vá» trang chÃ­nh">â† Vá» trang chÃ­nh</button>
      <div class="spacer"></div>
      <span class="badge">Xuáº¥t dá»¯ liá»‡u</span>
    </div>
    <div class="section">
      <div class="row">
        <button onclick="App.exportCSV()" data-voice="Táº£i tá»‡p CSV">Táº£i CSV</button>
        <button class="ghost" onclick="App.copyCSV()" data-voice="Sao chÃ©p CSV">Sao chÃ©p CSV</button>
      </div>
      <div class="help">DÃ¡n vÃ o Google Sheets Ä‘á»ƒ theo dÃµi dÃ i háº¡n.</div>
    </div>
  </section>

  <!-- Settings -->
  <section id="screen-settings" class="screen">
    <div class="row">
      <button onclick="App.nav('home')" data-voice="Vá» trang chÃ­nh">â† Vá» trang chÃ­nh</button>
      <div class="spacer"></div>
      <span class="badge">CÃ i Ä‘áº·t</span>
    </div>

    <div class="section">
      <div class="grid-2">
        <div>
          <label>MÃ£ há»c viÃªn (khÃ´ng dÃ¹ng tÃªn tháº­t)</label>
          <input type="text" id="inpId" placeholder="VD: HS001" />
        </div>
        <div>
          <label>Tuá»•i</label>
          <input type="number" id="inpAge" min="5" max="15" />
        </div>
        <div>
          <label>Khá»‘i/lá»›p</label>
          <input type="text" id="inpGrade" placeholder="VD: Lá»›p 2" />
        </div>
        <div>
          <label>PhÃ´ng chá»¯</label>
          <select id="selFont">
            <option>Lexend</option>
            <option>OpenDyslexic</option>
            <option selected>System Sans</option>
          </select>
        </div>
        <div>
          <label>Tá»‘c Ä‘á»™ TTS (0.6â€“1.4)</label>
          <input type="number" id="inpRate" value="0.9" step="0.05" min="0.6" max="1.4" />
        </div>
        <div>
          <label>Cáº¥p Ä‘á»™ Ä‘á»c ban Ä‘áº§u</label>
          <select id="selStartLevel"></select>
        </div>
      </div>
      <div class="row" style="margin-top:10px;">
        <button class="primary" onclick="App.saveSettings()" data-voice="LÆ°u cÃ i Ä‘áº·t">LÆ°u</button>
      </div>
      <div class="help">â€œSystem Sansâ€ tÆ°Æ¡ng thÃ­ch má»i mÃ¡y. Náº¿u mÃ¡y cÃ³ Lexend/OpenDyslexic, á»©ng dá»¥ng sáº½ Æ°u tiÃªn dÃ¹ng.</div>
    </div>

    <div class="section">
      <h3>Giao diá»‡n dá»… Ä‘á»c</h3>
      <div class="grid-2">
        <div>
          <label>Cá»¡ chá»¯ (px)</label>
          <input type="range" id="rngFS" min="16" max="28" step="1" />
        </div>
        <div>
          <label>GiÃ£n dÃ²ng</label>
          <input type="range" id="rngLH" min="1.4" max="2.2" step="0.05" />
        </div>
        <div>
          <label>GiÃ£n chá»¯</label>
          <input type="range" id="rngLS" min="0" max="0.08" step="0.005" />
        </div>
        <div>
          <label>Chiá»u cao thÆ°á»›c dÃ²ng</label>
          <input type="range" id="rngRuler" min="1.6" max="3.2" step="0.1" />
        </div>
        <div>
          <label>Chá»§ Ä‘á»</label>
          <select id="selTheme">
            <option value="calm">Calm (dá»‹u máº¯t)</option>
            <option value="vivid">Vivid (sinh Ä‘á»™ng)</option>
            <option value="contrast">TÆ°Æ¡ng pháº£n cao</option>
          </select>
        </div>
        <div>
          <label>Chuyá»ƒn Ä‘á»™ng</label>
          <select id="selMotion">
            <option value="on">Nháº¹ (khuyáº¿n nghá»‹)</option>
            <option value="off">Táº¯t chuyá»ƒn Ä‘á»™ng</option>
          </select>
        </div>
      </div>
      <div class="row" style="margin-top:10px;">
        <button class="ghost" onclick="App.ui.reset()" data-voice="KhÃ´i phá»¥c máº·c Ä‘á»‹nh">KhÃ´i phá»¥c máº·c Ä‘á»‹nh</button>
      </div>
      <div class="help">TÄƒng cá»¡ chá»¯, giÃ£n dÃ²ng/chá»¯ giÃºp giáº£m táº£i nháº­n thá»©c. TÆ°Æ¡ng pháº£n cao phÃ¹ há»£p mÃ´i trÆ°á»ng chÃ³i sÃ¡ng.</div>
    </div>

    <div class="section">
      <h3>Äá»“ng bá»™ Google Drive</h3>
      <div class="grid-2">
        <div>
          <label>Äá»“ng bá»™ (Apps Script URL)</label>
          <input type="url" id="inpSyncUrl" placeholder="https://script.google.com/macros/s/XXX/exec" />
        </div>
        <div>
          <label>Máº­t mÃ£ bÃ­ máº­t (SECRET)</label>
          <input type="text" id="inpSyncSecret" placeholder="docde-secret-2025" />
        </div>
      </div>
      <div class="row" style="margin-top:10px;">
        <button onclick="App.saveSync()" data-voice="LÆ°u cÃ i Ä‘áº·t Ä‘á»“ng bá»™">LÆ°u Ä‘á»“ng bá»™</button>
        <button class="ghost" onclick="App.testSync()" data-voice="Kiá»ƒm tra káº¿t ná»‘i Ä‘á»“ng bá»™">Kiá»ƒm tra káº¿t ná»‘i</button>
      </div>
      <div class="help">Sao chÃ©p URL Web App tá»« Google Apps Script (Execute as: Me, Access: Anyone). SECRET pháº£i trÃ¹ng trong Script.</div>
    </div>
  </section>

  <!-- Help -->
  <div id="modalHelp" class="modal">
    <div class="dialog">
      <h3>HÆ°á»›ng dáº«n nhanh</h3>
      <ul>
        <li>Ã‚m vá»‹: 5â€“7 phÃºt, 6â€“8 má»¥c tiÃªu theo lá»—i hay gáº·p.</li>
        <li>Tháº» tá»«: 5 phÃºt, 10â€“15 tháº» (Dá»…/Vá»«a/KhÃ³).</li>
        <li>Äá»c Ä‘oáº¡n: 3 láº§n/Ä‘oáº¡n, Ä‘o WCPM & % Ä‘Ãºng; lÃ m 2â€“3 cÃ¢u há»i hiá»ƒu.</li>
        <li>ThÆ°á»›c dÃ²ng: Báº­t trong Äá»c Ä‘oáº¡n. DÃ¹ng â–²/â–¼ Ä‘á»ƒ di chuyá»ƒn.</li>
        <li>Giá»ng nÃ³i trá»£ giÃºp: Nháº¥n giá»¯ 0.4 giÃ¢y lÃªn nÃºt Ä‘á»ƒ nghe tÃªn trÆ°á»›c khi báº¥m.</li>
      </ul>
      <div class="row">
        <div class="spacer"></div>
        <button onclick="document.getElementById('modalHelp').classList.remove('active')" data-voice="ÄÃ³ng hÆ°á»›ng dáº«n">ÄÃ£ hiá»ƒu</button>
      </div>
    </div>
  </div>

  <!-- Onboarding -->
  <div id="modalOnboard" class="modal">
    <div class="dialog">
      <h3>Thiáº¿t láº­p nhanh</h3>
      <div class="grid-2">
        <div>
          <label>MÃ£ há»c viÃªn</label>
          <input type="text" id="obId" placeholder="VD: HS001"/>
        </div>
        <div>
          <label>Tuá»•i</label>
          <input type="number" id="obAge" min="5" max="15"/>
        </div>
        <div>
          <label>Khá»‘i/lá»›p</label>
          <input type="text" id="obGrade" placeholder="VD: Lá»›p 2"/>
        </div>
      </div>
      <div class="row" style="margin-top:10px;">
        <button class="primary" onclick="App.finishOnboard()" data-voice="Báº¯t Ä‘áº§u sá»­ dá»¥ng">Báº¯t Ä‘áº§u</button>
      </div>
      <div class="help">Dá»¯ liá»‡u áº©n danh, chá»‰ lÆ°u cá»¥c bá»™ náº¿u báº¡n chÆ°a báº­t Äá»“ng bá»™.</div>
    </div>
  </div>

  <!-- Chá»n loáº¡i lá»—i -->
  <div id="errorMenu" class="modal" style="background: transparent;">
    <div class="dialog" style="max-width:380px;">
      <h3>Chá»n loáº¡i lá»—i</h3>
      <div class="row" style="flex-wrap: wrap;">
        <button onclick="App.reading.setErrType('tone')" data-voice="Sai thanh Ä‘iá»‡u">Sai thanh Ä‘iá»‡u</button>
        <button onclick="App.reading.setErrType('sx')" data-voice="Nháº§m s vÃ  x">Nháº§m s x</button>
        <button onclick="App.reading.setErrType('chtr')" data-voice="Nháº§m ch vÃ  tr">Nháº§m ch tr</button>
        <button onclick="App.reading.setErrType('omission')" data-voice="Bá» Ã¢m hoáº·c bá» tá»«">Bá» Ã¢m</button>
        <button onclick="App.reading.setErrType('insertion')" data-voice="ThÃªm Ã¢m hoáº·c thÃªm tá»«">ThÃªm Ã¢m</button>
        <button onclick="App.reading.setErrType('other')" data-voice="Lá»—i khÃ¡c">KhÃ¡c</button>
      </div>
      <div class="row" style="margin-top:8px;">
        <div class="spacer"></div>
        <button class="ghost" onclick="document.getElementById('errorMenu').classList.remove('active')" data-voice="ÄÃ³ng báº£ng chá»n lá»—i">ÄÃ³ng</button>
      </div>
    </div>
  </div>

  <!-- KhoÃ¡/thoÃ¡t Child Mode -->
  <div class="lockbar" id="lockbar" style="display:none;">
    <span>ğŸš¸ Tá»± há»c Ä‘ang báº­t</span>
    <button class="ghost" id="btnUnlock" data-voice="Giá»¯ ba giÃ¢y Ä‘á»ƒ thoÃ¡t tá»± há»c">Giá»¯ 3s Ä‘á»ƒ thoÃ¡t</button>
  </div>

</div>

<!-- Quick Dock ná»•i -->
<div class="dock" id="dock">
  <button id="btnAPlus" data-voice="TÄƒng cá»¡ chá»¯">A+</button>
  <button id="btnAMinus" data-voice="Giáº£m cá»¡ chá»¯">Aâˆ’</button>
  <button id="btnTheme" data-voice="Äá»•i chá»§ Ä‘á»">ğŸ¨</button>
  <button id="btnContrast" data-voice="Báº­t táº¯t tÆ°Æ¡ng pháº£n cao">HC</button>
  <button id="btnMotion" data-voice="Báº­t táº¯t chuyá»ƒn Ä‘á»™ng">â¯</button>
</div>

<div class="footerbar">
  <button onclick="App.nav('home')" data-voice="Trang chÃ­nh">Trang chÃ­nh</button>
  <button onclick="App.nav('pa')" data-voice="Ã‚m vá»‹">Ã‚m vá»‹</button>
  <button onclick="App.nav('cards')" data-voice="Tháº» tá»«">Tháº» tá»«</button>
  <button onclick="App.nav('reading')" data-voice="Äá»c Ä‘oáº¡n">Äá»c Ä‘oáº¡n</button>
  <button onclick="App.nav('dashboard')" data-voice="Báº£ng Ä‘iá»u khiá»ƒn">Dashboard</button>
</div>

<script>
/* ===========================
   Dá»® LIá»†U MáºªU (cÃ³ thá»ƒ chá»‰nh sá»­a)
   =========================== */
const CARDS = [
  { id:"w_0001", text:"bÃ©", tags:["basic"] },
  { id:"w_0002", text:"máº¹", tags:["basic"] },
  { id:"w_0003", text:"cÃ¡", tags:["basic","tone"] },
  { id:"w_0004", text:"chÃ¡o", tags:["chtr","tone"] },
  { id:"w_0005", text:"xanh", tags:["sx"] },
  { id:"w_0006", text:"sÃ¡ch", tags:["sx","tone"] },
  { id:"w_0007", text:"tranh", tags:["chtr"] },
  { id:"w_0008", text:"nhÃ ", tags:["basic"] },
  { id:"w_0009", text:"chÃ³", tags:["chtr","tone"] },
  { id:"w_0010", text:"rÃ¡o", tags:["tone"] }
];

const PA_ITEMS = [
  { type:"segment", target:"tranh", parts:["tr","anh"], speak:"tranh", tags:["chtr"] },
  { type:"segment", target:"sÃ¡ch", parts:["s","Ã¡ch"], speak:"sÃ¡ch", tags:["sx","tone"] },
  { type:"segment", target:"chÃ¡o", parts:["ch","Ã¡o"], speak:"chÃ¡o", tags:["chtr","tone"] },
  { type:"segment", target:"xanh", parts:["x","anh"], speak:"xanh", tags:["sx"] },
  { type:"tone", base:"ma", options:["ma","mÃ¡","mÃ ","máº£","mÃ£","máº¡"], correct:"mÃ¡", tags:["tone"] },
  { type:"tone", base:"ba", options:["ba","bÃ¡","bÃ ","báº£","bÃ£","báº¡"], correct:"bÃ ", tags:["tone"] },
  { type:"pair", pair:["sÃ´ng","xÃ´ng"], correctIndex:0, focus:"sx" },
  { type:"pair", pair:["chanh","tranh"], correctIndex:1, focus:"chtr" }
];

const PASSAGES = [
  { id:"p_001", level:1, text:"BÃ© Äƒn cÃ¡. Máº¹ mua rau. ChÃ³ cháº¡y nhanh.",
    questions:[
      { q:"Ai Äƒn cÃ¡?", choices:["BÃ©","Máº¹","ChÃ³"], ans:0, type:"literal" },
      { q:"Ai cháº¡y nhanh?", choices:["CÃ¡","ChÃ³","Máº¹"], ans:1, type:"literal" }
    ]},
  { id:"p_002", level:2, text:"Buá»•i sÃ¡ng, Lan tÆ°á»›i cÃ¢y trÆ°á»›c sÃ¢n. CÃ¢y nhá» cÃ³ lÃ¡ xanh. Máº¹ báº£o Lan tÆ°á»›i nháº¹ Ä‘á»ƒ Ä‘áº¥t khÃ´ng trÃ´i.",
    questions:[
      { q:"Lan lÃ m gÃ¬ buá»•i sÃ¡ng?", choices:["TÆ°á»›i cÃ¢y","QuÃ©t nhÃ ","Cho mÃ¨o Äƒn"], ans:0, type:"literal" },
      { q:"VÃ¬ sao tÆ°á»›i nháº¹?", choices:["Äá»ƒ Ä‘áº¥t khÃ´ng trÃ´i","VÃ¬ trá»i mÆ°a","VÃ¬ cÃ¢y lá»›n"], ans:0, type:"inferential" }
    ]},
  { id:"p_003", level:3, text:"HÃ´m nay lá»›p Lan trá»“ng rau á»Ÿ vÆ°á»n trÆ°á»ng. Má»—i báº¡n chÄƒm má»™t luá»‘ng. Lan nhá»• cá», báº¡n Nam tÆ°á»›i nÆ°á»›c. CÃ¡c em há»c cÃ¡ch Ä‘o khoáº£ng cÃ¡ch Ä‘á»ƒ gieo háº¡t Ä‘á»u. Cuá»‘i buá»•i, tháº§y khen cáº£ lá»›p lÃ m tá»‘t.",
    questions:[
      { q:"Báº¡n Nam lÃ m gÃ¬?", choices:["TÆ°á»›i nÆ°á»›c","Nhá»• cá»","Gieo háº¡t"], ans:0, type:"literal" },
      { q:"VÃ¬ sao pháº£i Ä‘o khoáº£ng cÃ¡ch?", choices:["Äá»ƒ gieo Ä‘á»u","Cho nhanh","VÃ¬ tháº§y báº£o"], ans:0, type:"inferential" }
    ]}
];

/* ===========================
   LÆ¯U TRá»® & TRáº NG THÃI
   =========================== */
const Store = {
  get(k, d){ try{ return JSON.parse(localStorage.getItem(k)) ?? d; }catch{ return d; } },
  set(k, v){ localStorage.setItem(k, JSON.stringify(v)); }
};
const now = () => Date.now();

const AppState = {
  learner: Store.get('learner', { id:"", age:null, grade:"", level:1, ttsRate:0.9, font:"System Sans" }),
  logs: Store.get('logs', []),
  cardDeck: Store.get('cards', null),
  childMode: Store.get('childMode', false),
  stars: Store.get('stars', 0),
  srInit(){
    if (!this.cardDeck){
      this.cardDeck = {};
      for (const c of CARDS) {
        this.cardDeck[c.id] = { id:c.id, easiness:2.5, interval:0, due: now() };
      }
      Store.set('cards', this.cardDeck);
    }
  }
};

/* ===========================
   TTS (Ä‘áº·t trÆ°á»›c VoiceUI)
   =========================== */
const TTS = {
  supported: 'speechSynthesis' in window,
  speak(text, rate=0.9){
    if (!this.supported) { return; }
    const ut = new SpeechSynthesisUtterance(text);
    ut.lang = 'vi-VN';
    ut.rate = rate;
    window.speechSynthesis.cancel();
    window.speechSynthesis.speak(ut);
  }
};

/* ===========================
   VOICE UI (Ä‘á»c tÃªn nÃºt, hÆ°á»›ng dáº«n)
   =========================== */
const VoiceUI = {
  enabled: JSON.parse(localStorage.getItem('voice_enabled') || 'true'),
  cooldownUntil: 0,
  rate(){ return (AppState?.learner?.ttsRate) || 0.9; },
  speak(msg){ if (!this.enabled) return; TTS.speak(msg, this.rate()); },
  say(msg, cd=700){ const t=Date.now(); if (t<this.cooldownUntil) return; this.cooldownUntil=t+cd; this.speak(msg); },
  toggle(on){ this.enabled = (on ?? !this.enabled); localStorage.setItem('voice_enabled', JSON.stringify(this.enabled)); return this.enabled; },
  attachButtonVoice(el){
    if (!el) return;
    const label = el.getAttribute('data-voice') || el.innerText?.trim() || 'nÃºt';
    let timer;
    const readLabel = ()=> VoiceUI.speak(label);
    el.addEventListener('pointerdown', ()=> { timer = setTimeout(readLabel, 400); });
    el.addEventListener('pointerup', ()=> { clearTimeout(timer); });
    el.addEventListener('pointerleave', ()=> { clearTimeout(timer); });
    el.addEventListener('focus', ()=> { if (VoiceUI.enabled) setTimeout(readLabel, 80); });
  },
  attachAll(){
    document.querySelectorAll('button, [role="button"]').forEach(btn => VoiceUI.attachButtonVoice(btn));
    const rateSlider = document.getElementById('rateSlider');
    if (rateSlider && !rateSlider._voiceBound){
      rateSlider.addEventListener('focus', ()=> VoiceUI.speak('Thanh tá»‘c Ä‘á»™ giá»ng Ä‘á»c'));
      rateSlider._voiceBound = true;
    }
  }
};
function speakFeedback(msg){ VoiceUI.say(msg); }

/* ===========================
   GHI Ã‚M & COACH
   =========================== */
const Recorder = {
  stream: null, rec: null, chunks: [], recording:false, lastBlob: null,
  async toggle(seconds=60){
    if (this.recording) { this.stop(); return; }
    if (!navigator.mediaDevices?.getUserMedia) { alert('Thiáº¿t bá»‹ khÃ´ng há»— trá»£ ghi Ã¢m'); return; }
    this.stream = await navigator.mediaDevices.getUserMedia({audio:true});
    this.rec = new MediaRecorder(this.stream);
    this.chunks = [];
    this.rec.ondataavailable = (e)=> this.chunks.push(e.data);
    this.rec.onstop = ()=>{
      this.lastBlob = new Blob(this.chunks, { type: 'audio/webm' });
      this.stream.getTracks().forEach(t=>t.stop());
      this.recording=false;
      speakFeedback('ÄÃ£ dá»«ng ghi. Nháº¥n Ä‘á»ƒ nghe láº¡i.');
    };
    this.rec.start(); this.recording = true;
    setTimeout(()=>{ if(this.recording) this.stop(); }, seconds*1000);
  },
  stop(){ if(this.rec && this.recording){ this.rec.stop(); } },
  async play(){
    if (!this.lastBlob) { alert('ChÆ°a cÃ³ báº£n ghi'); return; }
    const url = URL.createObjectURL(this.lastBlob); const a = new Audio(url); a.play();
  }
};

const Coach = {
  cooldown: 0,
  say(msg){
    const t = Date.now();
    if (t < this.cooldown) return;
    this.cooldown = t + 1200;
    TTS.speak(msg, AppState.learner.ttsRate || 0.9);
  }
};

/* ===========================
   UI STATE (dá»… Ä‘á»c & chá»§ Ä‘á»)
   =========================== */
const UIState = Store.get('ui', {
  fs: 18, lh: 1.75, ls: 0.02, ruler: 2.4,
  theme: 'calm', motion: true
});
const UI = {
  apply(){
    document.documentElement.style.setProperty('--fs', UIState.fs + 'px');
    document.documentElement.style.setProperty('--lh', UIState.lh);
    document.documentElement.style.setProperty('--ls', UIState.ls + 'em');
    document.documentElement.style.setProperty('--ruler-h', UIState.ruler + 'em');
    document.body.classList.toggle('theme-vivid', UIState.theme === 'vivid');
    document.body.classList.toggle('theme-contrast', UIState.theme === 'contrast');
    document.body.classList.toggle('no-motion', !UIState.motion);
  },
  setFS(delta){ UIState.fs = Math.max(16, Math.min(28, UIState.fs + delta)); this.save(); },
  setTheme(next){
    if (next) UIState.theme = next;
    else {
      UIState.theme = UIState.theme === 'calm' ? 'vivid' : (UIState.theme === 'vivid' ? 'contrast' : 'calm');
    }
    this.save();
  },
  toggleContrast(){ UIState.theme = (UIState.theme === 'contrast' ? 'calm' : 'contrast'); this.save(); },
  toggleMotion(){ UIState.motion = !UIState.motion; this.save(); },
  setFromControls(){
    const g = (id)=> document.getElementById(id);
    const fs = +g('rngFS').value; const lh = +g('rngLH').value; const ls = +g('rngLS').value; const ru = +g('rngRuler').value;
    const theme = g('selTheme').value; const motion = g('selMotion').value === 'on';
    UIState.fs = fs; UIState.lh = lh; UIState.ls = ls; UIState.ruler = ru; UIState.theme = theme; UIState.motion = motion;
    this.save(false);
  },
  fillControls(){
    const g = (id)=> document.getElementById(id);
    if (g('rngFS')) g('rngFS').value = UIState.fs;
    if (g('rngLH')) g('rngLH').value = UIState.lh;
    if (g('rngLS')) g('rngLS').value = UIState.ls;
    if (g('rngRuler')) g('rngRuler').value = UIState.ruler;
    if (g('selTheme')) g('selTheme').value = UIState.theme;
    if (g('selMotion')) g('selMotion').value = UIState.motion ? 'on' : 'off';
  },
  reset(){
    UIState.fs=18; UIState.lh=1.75; UIState.ls=0.02; UIState.ruler=2.4; UIState.theme='calm'; UIState.motion=true;
    this.save();
    VoiceUI.say('ÄÃ£ khÃ´i phá»¥c giao diá»‡n máº·c Ä‘á»‹nh');
  },
  save(speak=true){
    Store.set('ui', UIState);
    this.apply();
    this.fillControls();
    if (speak) VoiceUI.say('ÄÃ£ Ã¡p dá»¥ng giao diá»‡n');
  }
};

/* ===========================
   TIá»†N ÃCH
   =========================== */
const fmtTime = (ms) => {
  const s = Math.floor(ms/1000);
  const m = String(Math.floor(s/60)).padStart(2,'0');
  const r = String(s%60).padStart(2,'0');
  return m+':'+r;
};
const wordsOf = (text) => text.trim().split(/\s+/).filter(Boolean);
const detectTone = (syll) => {
  const map = {'Ã¡':'sáº¯c','áº¥':'sáº¯c','áº¯':'sáº¯c','Ã©':'sáº¯c','áº¿':'sáº¯c','Ã­':'sáº¯c','Ã³':'sáº¯c','á»‘':'sáº¯c','á»›':'sáº¯c','Ãº':'sáº¯c','á»©':'sáº¯c','Ã½':'sáº¯c',
    'Ã ':'huyá»n','áº§':'huyá»n','áº±':'huyá»n','Ã¨':'huyá»n','á»':'huyá»n','Ã¬':'huyá»n','Ã²':'huyá»n','á»“':'huyá»n','á»':'huyá»n','Ã¹':'huyá»n','á»«':'huyá»n','á»³':'huyá»n',
    'áº£':'há»i','áº©':'há»i','áº³':'há»i','áº»':'há»i','á»ƒ':'há»i','á»‰':'há»i','á»':'há»i','á»•':'há»i','á»Ÿ':'há»i','á»§':'há»i','á»­':'há»i','á»·':'há»i',
    'Ã£':'ngÃ£','áº«':'ngÃ£','áºµ':'ngÃ£','áº½':'ngÃ£','á»…':'ngÃ£','Ä©':'ngÃ£','Ãµ':'ngÃ£','á»—':'ngÃ£','á»¡':'ngÃ£','Å©':'ngÃ£','á»¯':'ngÃ£','á»¹':'ngÃ£',
    'áº¡':'náº·ng','áº­':'náº·ng','áº·':'náº·ng','áº¹':'náº·ng','á»‡':'náº·ng','á»‹':'náº·ng','á»':'náº·ng','á»™':'náº·ng','á»£':'náº·ng','á»¥':'náº·ng','á»±':'náº·ng','á»µ':'náº·ng' };
  for (const ch of syll) { if (map[ch]) return map[ch]; }
  return 'ngang';
};
const toneClass = (syll) => 'tone-' + detectTone(syll);

function drawLineChart(canvas, xs, ys, color='#2E7D32', yLabel=''){
  const ctx = canvas.getContext('2d');
  const W = canvas.width, H = canvas.height;
  ctx.clearRect(0,0,W,H);
  ctx.fillStyle='#fff'; ctx.fillRect(0,0,W,H);
  ctx.strokeStyle='#ddd'; ctx.beginPath();
  const pl=40, pr=10, pt=10, pb=30;
  ctx.moveTo(pl, pt); ctx.lineTo(pl, H-pb); ctx.lineTo(W-pr, H-pb); ctx.stroke();
  if (!ys.length) return;
  const yMin = Math.min(...ys), yMax = Math.max(...ys);
  const y0 = (yMin===yMax) ? yMin-1 : yMin;
  const y1 = (yMin===yMax) ? yMax+1 : yMax;
  const xScale = (i) => pl + (i/(Math.max(1, ys.length-1))) * (W-pl-pr);
  const yScale = (v) => H - pb - ((v - y0)/(y1 - y0)) * (H - pt - pb);
  ctx.strokeStyle='#eee';
  for (let i=0; i<=4; i++){ const ty = pt + i*(H-pt-pb)/4; ctx.beginPath(); ctx.moveTo(pl, ty); ctx.lineTo(W-pr, ty); ctx.stroke(); }
  ctx.strokeStyle=color; ctx.lineWidth=2; ctx.beginPath();
  ys.forEach((v,i)=>{ const x=xScale(i), y=yScale(v); if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y); }); ctx.stroke();
  ctx.fillStyle=color; ys.forEach((v,i)=>{ const x=xScale(i), y=yScale(v); ctx.beginPath(); ctx.arc(x,y,3,0,Math.PI*2); ctx.fill(); });
  ctx.fillStyle='#666'; ctx.font='12px system-ui'; ctx.fillText(yLabel, 6, 14);
}

function download(filename, text) {
  const blob = new Blob([text], {type: 'text/plain;charset=utf-8'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = filename; a.click(); URL.revokeObjectURL(url);
}

function toCSV(rows){
  if (!rows.length) return '';
  const headers = Object.keys(rows[0]);
  const esc = (v) => `"${String(v ?? '').replace(/"/g, '""')}"`;
  const lines = [headers.join(',')];
  for(const r of rows){ lines.push(headers.map(h=>esc(r[h])).join(',')); }
  return lines.join('\n');
}

/* ===========================
   ADAPTIVE ENGINE
   =========================== */
function adaptivePlan(logs, currentLevel=1){
  const recent = logs.filter(x=>x.type==='reading').slice(-3);
  if (!recent.length) return { nextLevel: currentLevel, scaffolds:['hint-on-demand'] };
  const acc3 = recent.reduce((s,x)=> s + (x.accuracy||0), 0)/recent.length;
  const wcpmTrend = recent[recent.length-1].wcpm - recent[0].wcpm;
  let nextLevel = currentLevel; let scaffolds = ['hint-on-demand'];
  if (acc3 >= 0.9 && wcpmTrend >= 10) nextLevel = currentLevel + 1;
  else if (acc3 < 0.75) { nextLevel = Math.max(1, currentLevel - 1); scaffolds = ['tts-per-syllable','one-line-mode','pointer']; }
  return { nextLevel, scaffolds, acc3, wcpmTrend };
}

/* ===========================
   SPACED REPETITION (SM-2 giáº£n lÆ°á»£c)
   =========================== */
function srReview(card, quality, nowMs=now()){
  let e = Math.max(1.3, (card.easiness ?? 2.5) + (0.1 - (5 - quality) * (0.08 + (5 - quality) * 0.02)));
  let i = quality < 3 ? 1 : (card.interval === 0 ? 1 : Math.round(card.interval * e));
  return { ...card, easiness: +e.toFixed(2), interval: i, due: nowMs + i * 24*3600*1000 };
}

/* ===========================
   Äá»’NG Bá»˜ (Apps Script)
   =========================== */
const Sync = {
  endpoint: Store.get('syncEndpoint', ''),
  secret: Store.get('syncSecret', ''),
  queue: Store.get('outbox', []),
  lastStatus: Store.get('syncLastStatus', 'chÆ°a cáº¥u hÃ¬nh'),
  setEndpoint(url){ this.endpoint = url.trim(); Store.set('syncEndpoint', this.endpoint); App.updateSyncStatus(); },
  setSecret(s){ this.secret = s.trim(); Store.set('syncSecret', this.secret); },
  enqueue(obj){
    this.queue.push({ url:this.endpoint, payload: obj, secret: this.secret });
    Store.set('outbox', this.queue);
    this.flush();
  },
  async flush(){
    App.updateSyncStatus();
    if (!this.endpoint || !this.secret) { this.lastStatus = 'chÆ°a cáº¥u hÃ¬nh'; Store.set('syncLastStatus', this.lastStatus); App.updateSyncStatus(); return; }
    if (!this.queue.length) { this.lastStatus = 'hÃ ng Ä‘á»£i trá»‘ng'; Store.set('syncLastStatus', this.lastStatus); App.updateSyncStatus(); return; }
    const newQueue = [];
    for (const item of this.queue){
      try{
        const res = await fetch(this.endpoint, {
          method:'POST',
          headers: { 'Content-Type':'application/json' },
          body: JSON.stringify({ secret: this.secret, data: item.payload })
        });
        if (!res.ok) throw new Error('HTTP '+res.status);
        await res.json().catch(()=>({ok:true}));
        this.lastStatus = 'Ä‘Ã£ gá»­i ' + (item.payload?.sessionId || '');
      }catch(e){
        newQueue.push(item);
        this.lastStatus = 'lá»—i, sáº½ thá»­ láº¡i';
      }
    }
    this.queue = newQueue;
    Store.set('outbox', this.queue);
    Store.set('syncLastStatus', this.lastStatus);
    App.updateSyncStatus();
  }
};

/* ===========================
   á»¨NG Dá»¤NG
   =========================== */
const App = {
  speak: (t)=> TTS.speak(t, AppState.learner.ttsRate || 0.9),
  nav(screen){
    document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
    const el = document.getElementById('screen-' + screen);
    if (el) el.classList.add('active');

    // Render theo mÃ n
    if (screen==='dashboard') App.dashboard.render();
    if (screen==='pa') { App.pa.render(); if (AppState.childMode) Coach.say('KÃ©o cÃ¡c máº£nh Ä‘á»ƒ ghÃ©p thÃ nh tá»«.'); }
    if (screen==='cards') { App.cards.render(); if (AppState.childMode) Coach.say('Cháº¡m nghe tá»« vÃ  chá»n khÃ³ hay dá»….'); }
    if (screen==='reading') { App.reading.init(); if (AppState.childMode) Coach.say('Nháº¥n báº¯t Ä‘áº§u rá»“i Ä‘á»c to. Gáº·p tá»« khÃ³ thÃ¬ cháº¡m Ä‘á»ƒ Ä‘Ã¡nh dáº¥u.'); }
    if (screen==='settings') { UI.fillControls(); }

    // HÆ°á»›ng dáº«n nÃ³i tá»± Ä‘á»™ng
    if (screen==='home') VoiceUI.speak('Trang chÃ­nh. Chá»n luyá»‡n Ã¢m vá»‹, tháº» tá»«, Ä‘á»c Ä‘oáº¡n, hoáº·c báº£ng Ä‘iá»u khiá»ƒn.');
    if (screen==='pa') VoiceUI.speak('Luyá»‡n Ã¢m vá»‹. KÃ©o hoáº·c cháº¡m Ä‘á»ƒ ghÃ©p Ã¢m. Nháº¥n giá»¯ nÃºt Ä‘á»ƒ nghe tÃªn chá»©c nÄƒng.');
    if (screen==='cards') VoiceUI.speak('Tháº» tá»«. Cháº¡m nghe tá»«, chá»n dá»…, vá»«a hoáº·c khÃ³.');
    if (screen==='reading') VoiceUI.speak('Äá»c Ä‘oáº¡n. Nháº¥n Báº¯t Ä‘áº§u Ä‘á»ƒ tÃ­nh giá». CÃ³ thanh trÆ°á»£t tá»‘c Ä‘á»™ giá»ng Ä‘á»c vÃ  thÆ°á»›c dÃ²ng.');
    if (screen==='dashboard') VoiceUI.speak('Báº£ng Ä‘iá»u khiá»ƒn. Xem tiáº¿n bá»™ vÃ  Ä‘á»“ng bá»™ dá»¯ liá»‡u.');
    if (screen==='settings') VoiceUI.speak('CÃ i Ä‘áº·t. Äiá»u chá»‰nh giao diá»‡n dá»… Ä‘á»c vÃ  Ä‘á»“ng bá»™.');
    if (screen==='export') VoiceUI.speak('Xuáº¥t dá»¯ liá»‡u. Táº£i CSV hoáº·c sao chÃ©p.');

    VoiceUI.attachAll();
  },
  toast(msg){ console.log('[Toast]', msg); },
  init(){
    // Ãp dá»¥ng giao diá»‡n
    UI.apply();

    // Font
    document.body.style.fontFamily = {
      'Lexend': '"Lexend", var(--font-body)',
      'OpenDyslexic': '"OpenDyslexic", var(--font-body)',
      'System Sans': 'var(--font-body)'
    }[AppState.learner.font || 'System Sans'];

    // SR init
    AppState.srInit();

    // Buttons
    const btnSettings = document.getElementById('btnSettings');
    if (btnSettings) btnSettings.onclick = ()=> App.nav('settings');
    const btnHelp = document.getElementById('btnHelp');
    if (btnHelp) btnHelp.onclick = ()=>{
      document.getElementById('modalHelp').classList.add('active');
      VoiceUI.speak('HÆ°á»›ng dáº«n. Nháº¥n giá»¯ nÃºt Ä‘á»ƒ nghe tÃªn trÆ°á»›c khi chá»n.');
    };

    // Child mode toggle
    const btnChild = document.getElementById('btnChild');
    const lockbar = document.getElementById('lockbar');
    const updateChildUI = ()=> {
      if (!btnChild) return;
      btnChild.textContent = AppState.childMode ? 'ğŸš¸ Tá»± há»c: Báº­t' : 'ğŸš¸ Tá»± há»c: Táº¯t';
      document.body.classList.toggle('child', AppState.childMode);
      if (lockbar) lockbar.style.display = AppState.childMode ? '' : 'none';
    };
    if (btnChild){
      btnChild.onclick = ()=>{
        AppState.childMode = !AppState.childMode;
        Store.set('childMode', AppState.childMode);
        updateChildUI();
        if (AppState.childMode) Coach.say('Cháº¿ Ä‘á»™ tá»± há»c Ä‘Ã£ báº­t. Con lÃ m theo hÆ°á»›ng dáº«n nhÃ©.');
      };
    }
    updateChildUI();

    // Unlock long press
    const unlockBtn = document.getElementById('btnUnlock');
    if (unlockBtn){
      let pressTimer;
      const resetTxt = ()=> unlockBtn.textContent = 'Giá»¯ 3s Ä‘á»ƒ thoÃ¡t';
      unlockBtn.addEventListener('pointerdown', ()=>{
        unlockBtn.textContent = 'Äang má»Ÿ khÃ³a...';
        pressTimer = setTimeout(()=>{
          AppState.childMode = false; Store.set('childMode', false);
          updateChildUI(); resetTxt();
          speakFeedback('ÄÃ£ thoÃ¡t cháº¿ Ä‘á»™ tá»± há»c');
        }, 3000);
      });
      unlockBtn.addEventListener('pointerup', ()=>{ clearTimeout(pressTimer); resetTxt(); });
      unlockBtn.addEventListener('pointerleave', ()=>{ clearTimeout(pressTimer); resetTxt(); });
    }

    // Levels
    const levels = Array.from(new Set(PASSAGES.map(p=>p.level))).sort((a,b)=>a-b);
    const selLevel = document.getElementById('selLevel');
    if (selLevel) selLevel.innerHTML = levels.map(l=> `<option value="${l}">Cáº¥p ${l}</option>`).join('');
    const selStartLevel = document.getElementById('selStartLevel');
    if (selStartLevel) selStartLevel.innerHTML = selLevel ? selLevel.innerHTML : '';

    // Settings fill
    if (selLevel && AppState.learner.level) selLevel.value = AppState.learner.level;
    if (selStartLevel && AppState.learner.level) selStartLevel.value = AppState.learner.level;
    const f = (id)=> document.getElementById(id);
    if (f('inpId')) f('inpId').value = AppState.learner.id || '';
    if (f('inpAge')) f('inpAge').value = AppState.learner.age || '';
    if (f('inpGrade')) f('inpGrade').value = AppState.learner.grade || '';
    if (f('selFont')) f('selFont').value = AppState.learner.font || 'System Sans';
    if (f('inpRate')) f('inpRate').value = AppState.learner.ttsRate || 0.9;
    if (f('rateSlider')) f('rateSlider').value = AppState.learner.ttsRate || 0.9;
    if (f('rateVal')) f('rateVal').textContent = (AppState.learner.ttsRate || 0.9).toFixed(2)+'x';

    // UI controls fill
    UI.fillControls();
    const bind = (id, handler)=> { const el = document.getElementById(id); if (el) el.addEventListener('input', handler); };
    bind('rngFS', ()=> UI.setFromControls());
    bind('rngLH', ()=> UI.setFromControls());
    bind('rngLS', ()=> UI.setFromControls());
    bind('rngRuler', ()=> UI.setFromControls());
    const sTheme = document.getElementById('selTheme'); if (sTheme) sTheme.addEventListener('change', ()=> UI.setFromControls());
    const sMotion = document.getElementById('selMotion'); if (sMotion) sMotion.addEventListener('change', ()=> UI.setFromControls());

    // Quick Dock
    const d = (id)=> document.getElementById(id);
    if (d('btnAPlus')) d('btnAPlus').onclick = ()=> { UI.setFS(+1); };
    if (d('btnAMinus')) d('btnAMinus').onclick = ()=> { UI.setFS(-1); };
    if (d('btnTheme')) d('btnTheme').onclick = ()=> { UI.setTheme(); };
    if (d('btnContrast')) d('btnContrast').onclick = ()=> { UI.toggleContrast(); };
    if (d('btnMotion')) d('btnMotion').onclick = ()=> { UI.toggleMotion(); };

    // Voice toggle
    const btnVoice = document.getElementById('btnVoice');
    const updateVoiceBtn = ()=> { if (btnVoice) btnVoice.textContent = (VoiceUI.enabled ? 'ğŸ”Š Giá»ng nÃ³i: Báº­t' : 'ğŸ”‡ Giá»ng nÃ³i: Táº¯t'); };
    if (btnVoice){
      btnVoice.onclick = ()=> { VoiceUI.toggle(); updateVoiceBtn(); VoiceUI.speak(VoiceUI.enabled ? 'ÄÃ£ báº­t giá»ng nÃ³i trá»£ giÃºp' : 'ÄÃ£ táº¯t giá»ng nÃ³i trá»£ giÃºp'); };
      updateVoiceBtn();
    }

    // PWA SW
    if ('serviceWorker' in navigator) navigator.serviceWorker.register('sw.js');

    // Online flush
    window.addEventListener('online', ()=> Sync.flush());

    // Initial sync status
    App.updateSyncStatus();
    Sync.flush();

    // Gáº¯n label giá»ng nÃ³i cho nÃºt hiá»‡n cÃ³
    VoiceUI.attachAll();

    // Má»Ÿ Home
    App.nav('home');
  },
  updateLearnerBadge(){
    const b = document.getElementById('learnerBadge'); const L = AppState.learner;
    if (b) b.textContent = L.id ? `MÃ£: ${L.id}, Cáº¥p: ${L.level || 1}` : 'ChÆ°a thiáº¿t láº­p';
  },
  updateNextLevelHint(){
    const plan = adaptivePlan(AppState.logs, AppState.learner.level || 1);
    const el = document.getElementById('nextLevelHint');
    if (el) el.textContent = `Cáº¥p ${plan.nextLevel}`;
  },
  updateStars(){ const el = document.getElementById('starCount'); if (el){ el.textContent = `â­ ${AppState.stars||0}`; Store.set('stars', AppState.stars||0); } },
  addStar(n=1){ AppState.stars = (AppState.stars||0) + n; App.updateStars(); App.celebrate(); },

  updateRateFromSlider(v){
    const rate = +v;
    AppState.learner.ttsRate = rate; Store.set('learner', AppState.learner);
    const rv = document.getElementById('rateVal'); if (rv) rv.textContent = rate.toFixed(2)+'x';
    VoiceUI.say(`Tá»‘c Ä‘á»™ ${rate.toFixed(2)} láº§n`, 600);
  },

  saveSettings(){
    const g = (id)=> document.getElementById(id);
    AppState.learner.id = g('inpId').value.trim();
    AppState.learner.age = +g('inpAge').value || null;
    AppState.learner.grade = g('inpGrade').value.trim();
    AppState.learner.font = g('selFont').value;
    AppState.learner.ttsRate = +g('inpRate').value || 0.9;
    AppState.learner.level = +g('selStartLevel').value || 1;
    Store.set('learner', AppState.learner);
    App.init();
    alert('ÄÃ£ lÆ°u cÃ i Ä‘áº·t.');
  },
  finishOnboard(){
    const id = document.getElementById('obId').value.trim();
    const age = +document.getElementById('obAge').value || null;
    const grade = document.getElementById('obGrade').value.trim();
    if (!id) { alert('HÃ£y nháº­p MÃ£ há»c viÃªn.'); return; }
    AppState.learner.id = id; AppState.learner.age = age; AppState.learner.grade = grade;
    AppState.learner.level = AppState.learner.level || 1;
    Store.set('learner', AppState.learner);
    App.updateLearnerBadge();
    document.getElementById('modalOnboard').classList.remove('active');
    VoiceUI.speak('ÄÃ£ thiáº¿t láº­p xong. VÃ o trang chÃ­nh Ä‘á»ƒ báº¯t Ä‘áº§u.');
  },

  saveSync(){
    const url = document.getElementById('inpSyncUrl').value.trim();
    const secret = document.getElementById('inpSyncSecret').value.trim();
    Sync.setEndpoint(url); Sync.setSecret(secret);
    alert('ÄÃ£ lÆ°u cÃ i Ä‘áº·t Ä‘á»“ng bá»™.');
    App.updateSyncStatus();
  },
  async testSync(){
    if (!Sync.endpoint || !Sync.secret) { alert('ChÆ°a cáº¥u hÃ¬nh URL/SECRET.'); return; }
    try{
      const res = await fetch(Sync.endpoint, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ secret: Sync.secret, ping:true }) });
      const js = await res.json();
      alert('Káº¿t ná»‘i OK: ' + JSON.stringify(js));
    }catch(e){ alert('KhÃ´ng káº¿t ná»‘i Ä‘Æ°á»£c. Kiá»ƒm tra URL hoáº·c quyá»n Web App.'); }
    App.updateSyncStatus();
  },
  showSyncHelp(){
    alert('Äá»“ng bá»™ cáº§n Google Apps Script Web App (Execute as: Me, Access: Anyone). DÃ¡n URL vÃ o pháº§n CÃ i Ä‘áº·t > Äá»“ng bá»™.');
  },
  updateSyncStatus(){
    const s = document.getElementById('syncStatus');
    if (!s) return;
    const q = Sync.queue?.length || 0;
    const status = Sync.endpoint ? `HÃ ng Ä‘á»£i: ${q} â€¢ ${Sync.lastStatus || ''}` : 'chÆ°a cáº¥u hÃ¬nh';
    s.textContent = 'Tráº¡ng thÃ¡i: ' + status;
  },

  exportCSV(){
    const rows = (AppState.logs||[]).map(x => ({
      learner_id: AppState.learner.id || '',
      date: new Date(x.ts).toISOString(),
      session_id: x.sessionId || '',
      type: x.type,
      level: x.level || '',
      passage_id: x.passageId || '',
      duration_ms: x.durationMs || '',
      total_words: x.totalWords || '',
      correct_words: x.correctWords || '',
      wcpm: x.wcpm || '',
      accuracy: x.accuracy || '',
      comp_correct: x.compCorrect ?? '',
      comp_total: x.compTotal ?? '',
      used_tts: x.usedTTS ?? '',
      errors_tone: x.errorsByType?.tone ?? 0,
      errors_sx: x.errorsByType?.sx ?? 0,
      errors_chtr: x.errorsByType?.chtr ?? 0,
      errors_omission: x.errorsByType?.omission ?? 0,
      errors_insertion: x.errorsByType?.insertion ?? 0,
      errors_other: x.errorsByType?.other ?? 0
    }));
    const csv = toCSV(rows);
    download(`docde_${AppState.learner.id || 'anon'}.csv`, csv);
  },
  copyCSV(){
    const rows = (AppState.logs||[]).map(x => ({
      learner_id: AppState.learner.id || '',
      date: new Date(x.ts).toISOString(),
      session_id: x.sessionId || '',
      type: x.type,
      level: x.level || '',
      passage_id: x.passageId || '',
      duration_ms: x.durationMs || '',
      total_words: x.totalWords || '',
      correct_words: x.correctWords || '',
      wcpm: x.wcpm || '',
      accuracy: x.accuracy || '',
      comp_correct: x.compCorrect ?? '',
      comp_total: x.compTotal ?? '',
      used_tts: x.usedTTS ?? '',
      errors_tone: x.errorsByType?.tone ?? 0,
      errors_sx: x.errorsByType?.sx ?? 0,
      errors_chtr: x.errorsByType?.chtr ?? 0,
      errors_omission: x.errorsByType?.omission ?? 0,
      errors_insertion: x.errorsByType?.insertion ?? 0,
      errors_other: x.errorsByType?.other ?? 0
    }));
    const csv = toCSV(rows);
    navigator.clipboard?.writeText(csv).then(()=> alert('ÄÃ£ sao chÃ©p CSV.')).catch(()=> alert('KhÃ´ng sao chÃ©p Ä‘Æ°á»£c. HÃ£y dÃ¹ng nÃºt Táº£i CSV.'));
  },
  resetConfirm(){
    if (confirm('XÃ“A TOÃ€N Bá»˜ Dá»® LIá»†U trÃªn thiáº¿t bá»‹ nÃ y?')) {
      localStorage.removeItem('logs'); AppState.logs = [];
      alert('ÄÃ£ xÃ³a.'); App.dashboard.render();
    }
  },

  /* ===== CELEBRATION ===== */
  celebrate(){
    const n = 14;
    for (let i=0;i<n;i++){
      const s = document.createElement('div');
      s.className = 'confetti';
      s.textContent = ['â­','âœ¨','ğŸŒŸ'][i%3];
      s.style.left = Math.random()*100 + 'vw';
      s.style.animationDuration = (1.8 + Math.random()*1.2) + 's';
      document.body.appendChild(s);
      setTimeout(()=> s.remove(), 3200);
    }
  },

  /* ===== PA ===== */
  pa: {
    idx: 0,
    render(){
      const wrap = document.getElementById('pa-container');
      wrap.innerHTML = '';
      const item = PA_ITEMS[this.idx % PA_ITEMS.length];
      if (!item) { wrap.textContent = 'Háº¿t bÃ i táº­p.'; return; }

      if (item.type === 'segment'){
        const box = document.createElement('div');
        box.className = 'section';
        box.innerHTML = `
          <div class="row">
            <div style="font-weight:700;">GhÃ©p Ã¢m/tiáº¿ng thÃ nh tá»«</div>
            <div class="spacer"></div>
            <button class="tts" data-voice="Nghe máº«u" onclick="TTS.speak('${item.speak || item.target}', ${AppState.learner.ttsRate || 0.9})">ğŸ”Š</button>
          </div>
          <div class="big-text" style="margin-top:8px;">
            <span class="token ${toneClass(item.target)}">${item.target}</span>
          </div>
          <div style="margin:8px 0 4px;">KÃ©o cÃ¡c máº£nh bÃªn dÆ°á»›i vÃ o khung theo thá»© tá»± Ä‘Ãºng:</div>
          <div class="dropzone" id="dz"></div>
          <div class="inline-buttons" id="parts"></div>
          <div class="row" style="margin-top:10px;">
            <button class="primary" data-voice="Kiá»ƒm tra Ä‘Ã¡p Ã¡n" onclick="App.pa.checkSegment()">Kiá»ƒm tra</button>
            <div class="spacer"></div>
            <button class="ghost" data-voice="BÃ i khÃ¡c" onclick="App.pa.next()">BÃ i khÃ¡c</button>
          </div>
        `;
        wrap.appendChild(box);
        const shuffled = [...item.parts].sort(()=>Math.random()-0.5);
        const partsDiv = box.querySelector('#parts');
        shuffled.forEach((p)=>{
          const el = document.createElement('div');
          el.className='chip'; el.draggable = true; el.textContent = p; el.dataset.value = p;
          el.addEventListener('dragstart', e => e.dataTransfer.setData('text/plain', p));
          el.addEventListener('click', ()=> { // há»— trá»£ cháº¡m Ä‘á»ƒ Ä‘Æ°a vÃ o khung
            const dz = box.querySelector('#dz'); const chip = document.createElement('div');
            chip.className='chip'; chip.textContent = p; chip.dataset.value=p; chip.onclick = ()=> chip.remove(); dz.appendChild(chip);
          });
          partsDiv.appendChild(el);
        });
        const dz = box.querySelector('#dz');
        dz.addEventListener('dragover', e => e.preventDefault());
        dz.addEventListener('drop', e => { e.preventDefault(); const val = e.dataTransfer.getData('text/plain'); const chip = document.createElement('div'); chip.className='chip'; chip.textContent = val; chip.dataset.value = val; chip.onclick = () => chip.remove(); dz.appendChild(chip); });

        if (AppState.childMode) Coach.say('KÃ©o hoáº·c cháº¡m Ä‘á»ƒ Ä‘Æ°a máº£nh vÃ o khung. RÃ¡p thÃ nh tá»« á»Ÿ trÃªn.');
      }
      else if (item.type === 'tone'){
        const box = document.createElement('div');
        box.className = 'section';
        box.innerHTML = `
          <div class="row">
            <div style="font-weight:700;">Chá»n thanh Ä‘iá»‡u Ä‘Ãºng</div>
            <div class="spacer"></div>
            <button class="tts" data-voice="Nghe máº«u Ä‘Ãºng" onclick="TTS.speak('${item.correct}', ${AppState.learner.ttsRate || 0.9})">ğŸ”Š</button>
          </div>
          <div class="big-text" style="margin-top:8px;">Gá»‘c: <span class="token">${item.base}</span></div>
          <div class="inline-buttons" id="toneOps" style="margin-top:8px;"></div>
          <div class="row" style="margin-top:10px;">
            <button class="ghost" data-voice="BÃ i khÃ¡c" onclick="App.pa.next()">BÃ i khÃ¡c</button>
          </div>
        `;
        wrap.appendChild(box);
        const ops = box.querySelector('#toneOps');
        item.options.forEach(opt=>{
          const btn = document.createElement('button');
          btn.textContent = opt;
          btn.setAttribute('data-voice', `Chá»n ${opt}`);
          btn.onclick = ()=>{
            const ok = opt===item.correct;
            speakFeedback(ok ? 'ÄÃºng rá»“i' : 'ChÆ°a Ä‘Ãºng, con thá»­ láº¡i');
            if (ok) App.pa.next();
          };
          btn.className = 'token ' + toneClass(opt);
          ops.appendChild(btn);
        });
        if (AppState.childMode) Coach.say('Chá»n tá»« cÃ³ thanh Ä‘Ãºng.');
      }
      else if (item.type === 'pair'){
        const target = item.pair[item.correctIndex];
        const box = document.createElement('div');
        box.className = 'section';
        box.dataset.correct = String(item.correctIndex);
        box.innerHTML = `
          <div class="row">
            <div style="font-weight:700;">Cáº·p tá»‘i thiá»ƒu (${item.focus || ''}) â€“ Nghe vÃ  chá»n Ä‘Ãºng</div>
            <div class="spacer"></div>
            <button class="tts" data-voice="Nghe tá»« cáº§n chá»n" onclick="TTS.speak('${target}', ${AppState.learner.ttsRate || 0.9})">ğŸ”Š</button>
          </div>
          <div class="inline-buttons" style="margin-top:8px;">
            <button data-voice="Chá»n ${item.pair[0]}" onclick="App.pa.answerPair(0)">${item.pair[0]}</button>
            <button data-voice="Chá»n ${item.pair[1]}" onclick="App.pa.answerPair(1)">${item.pair[1]}</button>
          </div>
          <div class="row" style="margin-top:10px;">
            <button class="ghost" data-voice="BÃ i khÃ¡c" onclick="App.pa.next()">BÃ i khÃ¡c</button>
          </div>
        `;
        wrap.appendChild(box);
        if (AppState.childMode) Coach.say('Nghe vÃ  cháº¡m vÃ o tá»« con nghe Ä‘Æ°á»£c.');
      }
      VoiceUI.attachAll();
    },
    checkSegment(){
      const item = PA_ITEMS[this.idx % PA_ITEMS.length];
      const vals = Array.from(document.querySelectorAll('#dz .chip')).map(x=>x.dataset.value);
      const ok = vals.join('') === item.parts.join('');
      speakFeedback(ok ? 'ÄÃºng rá»“i' : 'ChÆ°a Ä‘Ãºng, con thá»­ sáº¯p xáº¿p láº¡i');
      if (ok) this.next();
    },
    answerPair(i){
      const container = document.getElementById('pa-container');
      const box = container.querySelector('[data-correct]');
      const correct = box ? +box.dataset.correct : null;
      if (i===correct) { speakFeedback('ÄÃºng'); this.next(); } else speakFeedback('ChÆ°a Ä‘Ãºng, thá»­ nghe láº¡i nhÃ©');
    },
    next(){ this.idx = (this.idx+1)%PA_ITEMS.length; this.render(); }
  },

  /* ===== CARDS ===== */
  cards: {
    current:null,
    dueList(){
      const deck = AppState.cardDeck;
      return CARDS.map(c => ({...c, _deck: deck[c.id]})).sort((a,b) => (a._deck?.due ?? 0) - (b._deck?.due ?? 0));
    },
    render(){
      const wrap = document.getElementById('cards-container');
      const list = this.dueList();
      const next = list[0];
      this.current = next;
      if (!next){ wrap.textContent='KhÃ´ng cÃ³ tháº» nÃ o.'; return; }
      const dueIn = Math.max(0, next._deck.due - now());
      wrap.innerHTML = `
        <div class="big-text"><span class="token ${toneClass(next.text)}">${next.text}</span></div>
        <div class="inline-buttons" style="margin-top:10px;">
          <button class="tts" data-voice="Nghe tá»«" onclick="TTS.speak('${next.text}', ${AppState.learner.ttsRate || 0.9})">ğŸ”Š Nghe</button>
          <button class="ghost" data-voice="Bá» qua tháº» nÃ y" onclick="App.cards.nextCard()">Bá» qua</button>
        </div>
        <div class="row" style="margin-top:12px;">
          <div class="spacer"></div>
          <button onclick="App.cards.grade(5)" class="primary" data-voice="ÄÃ¡nh giÃ¡ dá»…">Dá»…</button>
          <button onclick="App.cards.grade(3)" data-voice="ÄÃ¡nh giÃ¡ vá»«a">Vá»«a</button>
          <button onclick="App.cards.grade(1)" class="danger" data-voice="ÄÃ¡nh giÃ¡ khÃ³">KhÃ³</button>
        </div>
        <div class="note" style="margin-top:10px;">Thá»i Ä‘iá»ƒm Ã´n tiáº¿p: ${dueIn ? 'chÆ°a Ä‘áº¿n háº¡n' : 'Ä‘Ã£ Ä‘áº¿n'}</div>
      `;
      VoiceUI.attachAll();
      if (AppState.childMode) setTimeout(()=> TTS.speak(next.text, AppState.learner.ttsRate || 0.9), 300);
    },
    grade(q){
      const c = this.current; if (!c) return;
      AppState.cardDeck[c.id] = srReview(AppState.cardDeck[c.id], q);
      Store.set('cards', AppState.cardDeck);
      speakFeedback(q>=5 ? 'Dá»…' : (q>=3 ? 'Vá»«a' : 'KhÃ³'));
      App.addStar(1);
      this.nextCard();
    },
    nextCard(){ this.render(); }
  },

  /* ===== READING ===== */
  reading: {
    level: AppState.learner.level || 1,
    passage: null, started: false, startTime: 0, timerId: null, usedTTS: 0,
    markMode: 'normal', errors: {}, tokenElems: [], _sessionTemp: null, _errTarget: null,
    rulerOn: false, rulerY: 0,
    init(){
      const levels = Array.from(new Set(PASSAGES.map(p=>p.level))).sort((a,b)=>a-b);
      const sel = document.getElementById('selLevel');
      if (sel) { sel.value = String(this.level || levels[0]); this.chooseLevel(sel.value); }
      const btnF = document.getElementById('btnFocus');
      if (btnF) btnF.textContent = 'Cháº¿ Ä‘á»™ 1 dÃ²ng: ' + (AppState.childMode?'Báº­t':'Táº¯t');
      if (AppState.childMode) this.ensureFocusOn();
      this.markMode = AppState.childMode ? 'error' : 'normal';
      this.errors = {};
      const sW = document.getElementById('statWCPM'); if (sW) sW.textContent='â€”';
      const sA = document.getElementById('statAcc'); if (sA) sA.textContent='â€”';
      const t = document.getElementById('timer'); if (t) t.textContent='00:00';

      // Ruler button text
      const bR = document.getElementById('btnRuler');
      if (bR) bR.textContent = 'ThÆ°á»›c dÃ²ng: ' + (this.rulerOn ? 'Báº­t' : 'Táº¯t');
    },
    ensureFocusOn(){
      const pv = document.getElementById('passageView');
      pv.style.maxHeight = '3.4em'; pv.style.overflow = 'hidden';
      pv.style.maskImage = 'linear-gradient(180deg, black 60%, transparent 100%)';
      const btnF = document.getElementById('btnFocus');
      if (btnF) btnF.textContent = 'Cháº¿ Ä‘á»™ 1 dÃ²ng: Báº­t';
    },
    chooseLevel(lv){
      this.level = +lv;
      const candidates = PASSAGES.filter(p=>p.level===this.level);
      this.passage = candidates[0] || PASSAGES[0];
      this.renderPassage();
    },
    renderPassage(){
      const view = document.getElementById('passageView');
      view.innerHTML = '';
      const tokens = wordsOf(this.passage.text);
      this.tokenElems = tokens.map((w,i)=>{
        const span = document.createElement('span');
        span.className = 'token ' + toneClass(w);
        span.textContent = w + ' ';
        span.dataset.idx = i;
        span.onclick = () => this.onTokenClick(i, span);
        span.oncontextmenu = (e)=> { e.preventDefault(); this.openErrMenu(i); };
        span.onpointerdown = ()=> { if (VoiceUI.enabled) TTS.speak(w, AppState.learner.ttsRate || 0.9); };
        view.appendChild(span);
        return span;
      });
      // Ruler
      let ruler = document.getElementById('rulerBar');
      if (!ruler){ ruler = document.createElement('div'); ruler.id = 'rulerBar'; ruler.className = 'ruler'; view.appendChild(ruler); }
      ruler.style.display = this.rulerOn ? '' : 'none';
      this.rulerY = this.rulerY || 0;
      ruler.style.transform = `translateY(${this.rulerY}px)`;

      // Click vÃ¹ng trá»‘ng Ä‘á»ƒ Ä‘áº·t thÆ°á»›c dÃ²ng
      view.addEventListener('pointerdown', (e)=>{
        if (!this.rulerOn) return;
        if (e.target.id === 'passageView'){ // chá»‰ khi cháº¡m vÃ¹ng trá»‘ng
          const rect = view.getBoundingClientRect();
          const y = e.clientY - rect.top - (view.scrollTop || 0);
          this.setRulerAt(y - parseFloat(getComputedStyle(ruler).height)/2);
        }
      });

      const sec = document.getElementById('compSection');
      if (sec) sec.style.display='none';
      const qWrap = document.getElementById('questions');
      if (qWrap) qWrap.innerHTML='';
      VoiceUI.attachAll();
    },
    toggleRuler(){
      this.rulerOn = !this.rulerOn;
      const ruler = document.getElementById('rulerBar');
      if (ruler) ruler.style.display = this.rulerOn ? '' : 'none';
      const bR = document.getElementById('btnRuler');
      if (bR) bR.textContent = 'ThÆ°á»›c dÃ²ng: ' + (this.rulerOn ? 'Báº­t' : 'Táº¯t');
      VoiceUI.say(this.rulerOn ? 'ÄÃ£ báº­t thÆ°á»›c dÃ²ng' : 'ÄÃ£ táº¯t thÆ°á»›c dÃ²ng');
    },
    moveRuler(dir){ // -1 lÃªn, 1 xuá»‘ng
      if (!this.rulerOn) return;
      const step = 24; // px
      this.setRulerAt(this.rulerY + dir*step);
    },
    setRulerAt(y){
      const view = document.getElementById('passageView');
      const ruler = document.getElementById('rulerBar');
      if (!ruler || !view) return;
      const maxY = Math.max(0, view.clientHeight - ruler.clientHeight);
      this.rulerY = Math.max(0, Math.min(maxY, y));
      ruler.style.transform = `translateY(${this.rulerY}px)`;
    },
    onTokenClick(i, el){
      if (this.markMode!=='error') return;
      if (this.errors[i]) { delete this.errors[i]; el.style.outline = 'none'; }
      else { this.errors[i] = { type: 'other' }; el.style.outline = '3px solid var(--danger)'; }
      this.updateStatsLive();
    },
    openErrMenu(i){
      if (this.markMode!=='error') return;
      this._errTarget = i; document.getElementById('errorMenu').classList.add('active');
    },
    setErrType(t){
      if (this._errTarget==null) return;
      this.errors[this._errTarget] = { type: t };
      const el = this.tokenElems[this._errTarget]; if (el) el.style.outline = '3px solid var(--danger)';
      document.getElementById('errorMenu').classList.remove('active');
      this.updateStatsLive();
    },
    markMode(mode){
      this.markMode = mode;
      const be = document.getElementById('btnErr'); const bn = document.getElementById('btnNorm');
      if (be) be.className = mode==='error'? 'hint' : 'ghost';
      if (bn) bn.className = mode==='normal'? 'hint' : 'ghost';
      VoiceUI.say(mode==='error' ? 'Äang á»Ÿ cháº¿ Ä‘á»™ Ä‘Ã¡nh dáº¥u lá»—i' : 'Äang á»Ÿ cháº¿ Ä‘á»™ bÃ¬nh thÆ°á»ng');
    },
    toggleFocus(){
      const pv = document.getElementById('passageView');
      const isOne = pv.style.maxHeight;
      if (isOne){ pv.style.maxHeight = ''; pv.style.overflow = ''; pv.style.maskImage = ''; const btnF = document.getElementById('btnFocus'); if (btnF) btnF.textContent = 'Cháº¿ Ä‘á»™ 1 dÃ²ng: Táº¯t'; }
      else { this.ensureFocusOn(); }
    },
    speakPassage(){ this.usedTTS++; TTS.speak(this.passage.text, AppState.learner.ttsRate || 0.9); },
    start(){
      if (this.started) return;
      this.started = true; this.startTime = now(); this.errors = {};
      this.updateTimer();
      const bs = document.getElementById('btnStartRead'); const be = document.getElementById('btnStopRead');
      if (bs) bs.disabled = true; if (be) be.disabled = false;
      this.markMode = 'error';
      const b1 = document.getElementById('btnErr'); const b2 = document.getElementById('btnNorm');
      if (b1) b1.className = 'hint'; if (b2) b2.className = 'ghost';
      speakFeedback('Báº¯t Ä‘áº§u tÃ­nh giá». Cá»‘ gáº¯ng Ä‘á»c Ä‘á»u nhÃ©');
    },
    stop(){
      if (!this.started) return;
      this.started = false; clearTimeout(this.timerId);
      const bs = document.getElementById('btnStartRead'); const be = document.getElementById('btnStopRead');
      if (bs) bs.disabled = false; if (be) be.disabled = true;

      const dur = now() - this.startTime; const total = wordsOf(this.passage.text).length;
      const wrong = Object.keys(this.errors).length; const correct = Math.max(0, total - wrong);
      const minutes = Math.max(0.5, dur/60000);
      const wcpm = Math.round(correct / minutes); const acc = +(correct/total).toFixed(3);

      this.renderQuestions();
      this._sessionTemp = { dur, total, correct, wcpm, acc };
      const sW = document.getElementById('statWCPM'); if (sW) sW.textContent = wcpm;
      const sA = document.getElementById('statAcc'); if (sA) sA.textContent = (acc*100).toFixed(0) + '%';
      speakFeedback(`ÄÃ£ dá»«ng. Tá»‘c Ä‘á»™ ${wcpm} tá»« má»™t phÃºt. ChÃ­nh xÃ¡c ${Math.round(acc*100)} pháº§n trÄƒm. Tráº£ lá»i cÃ¢u há»i nhÃ©.`);
    },
    updateTimer(){
      if (!this.started) return;
      const t = now() - this.startTime; const el = document.getElementById('timer'); if (el) el.textContent = fmtTime(t);
      this.timerId = setTimeout(()=> this.updateTimer(), 200); this.updateStatsLive();
    },
    updateStatsLive(){
      if (!this.started) return;
      const dur = now() - this.startTime; const total = wordsOf(this.passage.text).length;
      const wrong = Object.keys(this.errors).length; const correct = Math.max(0, total - wrong);
      const minutes = Math.max(0.5, dur/60000); const wcpm = Math.round(correct / minutes);
      const acc = +(correct/total).toFixed(3);
      const sW = document.getElementById('statWCPM'); if (sW) sW.textContent = wcpm;
      const sA = document.getElementById('statAcc'); if (sA) sA.textContent = (acc*100).toFixed(0) + '%';
    },
    toggleRec(){
      const btn = document.getElementById('btnRec');
      if (!Recorder.recording && !Recorder.lastBlob){
        Recorder.toggle(); if (btn) btn.textContent = 'Äang ghi... Nháº¥n Ä‘á»ƒ dá»«ng';
      } else if (Recorder.recording){
        Recorder.stop(); if (btn) btn.textContent = 'Nghe láº¡i báº£n ghi';
      } else { Recorder.play(); }
    },
    renderQuestions(){
      const sec = document.getElementById('compSection');
      const qWrap = document.getElementById('questions'); if (!qWrap || !sec) return;
      qWrap.innerHTML = '';
      for (const [i,q] of this.passage.questions.entries()){
        const div = document.createElement('div'); div.className = 'question';
        div.innerHTML = `<div><b>CÃ¢u ${i+1}:</b> ${q.q}</div>`;
        const opts = document.createElement('div'); opts.className='inline-buttons';
        q.choices.forEach((c, idx)=>{
          const b = document.createElement('button');
          b.textContent = c;
          b.setAttribute('data-voice', `Chá»n Ä‘Ã¡p Ã¡n ${c}`);
          b.onclick = ()=> { div.dataset.sel = idx; Array.from(opts.children).forEach(ch => ch.style.outline='none'); b.style.outline = '2px solid var(--primary)'; };
          opts.appendChild(b);
        });
        div.appendChild(opts); qWrap.appendChild(div);
      }
      sec.style.display = '';
      VoiceUI.attachAll();
    },
    finishComp(){
      const chosen = Array.from(document.querySelectorAll('#questions .question')).map((div,i)=>{
        const sel = +(div.dataset.sel ?? -1); const correct = this.passage.questions[i].ans;
        return { sel, correct };
      });
      const compCorrect = chosen.filter(x=>x.sel===x.correct).length; const compTotal = this.passage.questions.length;

      const temp = this._sessionTemp || {};
      const errorsByType = { tone:0, sx:0, chtr:0, omission:0, insertion:0, other:0 };
      Object.values(this.errors).forEach(e => { if (errorsByType[e.type]!=null) errorsByType[e.type]++; else errorsByType.other++; });

      const log = {
        type: 'reading',
        learnerId: AppState.learner.id || '',
        sessionId: Math.random().toString(36).slice(2,10),
        ts: now(),
        passageId: this.passage.id,
        level: this.level,
        durationMs: temp.dur || 0,
        totalWords: temp.total || 0,
        correctWords: temp.correct || 0,
        wcpm: temp.wcpm || 0,
        accuracy: temp.acc || 0,
        compCorrect, compTotal,
        errorsByType, usedTTS: this.usedTTS || 0, scaffolds: []
      };

      AppState.logs.push(log); Store.set('logs', AppState.logs);

      // ThÆ°á»Ÿng sao
      const recent = AppState.logs.filter(x=>x.type==='reading').slice(-2);
      const lastW = recent.length>=2 ? recent[recent.length-2].wcpm : 0;
      if (log.accuracy >= 0.9 || (lastW && log.wcpm > lastW)) { App.addStar(1); }

      alert(`HoÃ n táº¥t! WCPM: ${log.wcpm}, ChÃ­nh xÃ¡c: ${(log.accuracy*100).toFixed(0)}%, Hiá»ƒu: ${compCorrect}/${compTotal}`);
      speakFeedback(`HoÃ n thÃ nh bÃ i Ä‘á»c. Tráº£ lá»i Ä‘Ãºng ${compCorrect} trÃªn ${compTotal}.`);

      // Adaptive
      AppState.learner.level = adaptivePlan(AppState.logs, AppState.learner.level).nextLevel; Store.set('learner', AppState.learner);
      App.updateLearnerBadge(); App.updateNextLevelHint();

      // Äá»“ng bá»™
      Sync.enqueue(log);

      // Reset
      this.usedTTS = 0; this._sessionTemp = null;
      const sec = document.getElementById('compSection'); if (sec) sec.style.display='none';
      if (AppState.childMode) Coach.say('Con lÃ m tá»‘t láº¯m!');
    }
  },

  /* ===== DASHBOARD ===== */
  dashboard: {
    render(){
      const logs = AppState.logs.filter(x=>x.type==='reading');
      const xs = logs.map(x=> new Date(x.ts).toLocaleDateString());
      const wc = logs.map(x=> x.wcpm);
      const ac = logs.map(x=> +(x.accuracy*100).toFixed(0));
      const du = logs.map(x=> Math.round((x.durationMs||0)/1000));
      const err = logs.reduce((acc, l) => {
        for (const k of ['tone','sx','chtr','omission','insertion','other']){
          acc[k] = (acc[k] || 0) + (l.errorsByType?.[k] || 0);
        } return acc;
      }, {});
      drawLineChart(document.getElementById('chartWCPM'), xs, wc, '#2E7D32', 'WCPM');
      drawLineChart(document.getElementById('chartACC'), xs, ac, '#6A1B9A', '% Ä‘Ãºng');
      drawLineChart(document.getElementById('chartDUR'), xs, du, '#1565C0', 'GiÃ¢y');
      drawLineChart(document.getElementById('chartERR'), Object.keys(err), Object.values(err), '#C62828', 'Tá»•ng lá»—i');
      App.updateSyncStatus();
      VoiceUI.attachAll();
    }
  }
};

window.addEventListener('load', () => { App.init(); });
</script>
</body>
</html>