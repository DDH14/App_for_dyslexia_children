<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Đọc Dễ – Hỗ trợ trẻ rối loạn đọc</title>
  <meta name="description" content="Luyện âm vị, thẻ từ, đọc trôi chảy (WCPM), hiểu nội dung; TTS, ghi âm, Voice UI, dashboard, xuất CSV, đồng bộ Google Drive." />
  <link rel="manifest" href="manifest.webmanifest">
  <meta name="theme-color" content="#FFF3D6" />
  <link rel="icon" href="data:image/svg+xml;utf8,
  <svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 128 128'>
    <rect width='128' height='128' fill='%23FFF3D6'/>
    <text x='50%' y='58%' dominant-baseline='middle' text-anchor='middle' font-size='80' font-family='sans-serif' fill='%23111'>Đ</text>
  </svg>">
  <link rel="stylesheet" href="styles.css" />
</head>
<body>
<div class="app">
  <header class="appbar">
    <div>
      <div class="title">Đọc Dễ <span class="stars" id="starCount">⭐ 0</span></div>
      <div class="subtitle">Âm vị • Thẻ từ • Đọc trôi chảy • Dashboard</div>
    </div>
    <div class="toolbar">
      <span id="learnerBadge" class="badge">Chưa thiết lập</span>
      <button class="tog" id="btnChild" data-voice="Bật hoặc tắt chế độ tự học">🚸 Tự học: Tắt</button>
      <button class="tog" id="btnVoice" data-voice="Bật hoặc tắt giọng nói trợ giúp">🔊 Giọng nói: Bật</button>
      <button class="ghost setup-only" id="btnSettings" data-voice="Cài đặt">Cài đặt</button>
      <button class="ghost" id="btnHelp" data-voice="Hướng dẫn">Hướng dẫn</button>
    </div>
  </header>

  <!-- HOME -->
  <section id="screen-home" class="screen active">
    <div class="home-grid">
      <div class="card">
        <h3>🎯 Luyện âm vị</h3>
        <div class="note">Kéo‑thả âm/tiếng, thanh điệu, cặp tối thiểu.</div>
        <div class="inline-buttons" style="margin-top:10px;">
          <button class="primary" onclick="App.nav('pa')" data-voice="Luyện âm vị. Bắt đầu">Bắt đầu</button>
          <button class="tts" onclick="App.speak('Luyện âm vị')" data-voice="Nghe hướng dẫn Luyện âm vị">🔊 Nghe</button>
        </div>
      </div>

      <div class="card">
        <h3>🃏 Thẻ từ</h3>
        <div class="note">Nhận diện từ theo lặp lại giãn cách.</div>
        <div class="inline-buttons" style="margin-top:10px;">
          <button class="primary" onclick="App.nav('cards')" data-voice="Thẻ từ. Ôn tập">Ôn tập</button>
        </div>
      </div>

      <div class="card">
        <h3>📖 Đọc đoạn</h3>
        <div class="note">Đo WCPM, % đúng, hiểu nội dung; ghi âm – nghe lại.</div>
        <div class="inline-buttons" style="margin-top:10px;">
          <button class="primary" onclick="App.nav('reading')" data-voice="Đọc đoạn. Luyện đọc">Luyện đọc</button>
        </div>
      </div>

      <div class="card">
        <h3>📊 Dashboard</h3>
        <div class="note">Biểu đồ tiến bộ, lỗi theo loại, xuất CSV, đồng bộ.</div>
        <div class="inline-buttons" style="margin-top:10px;">
          <button class="primary" onclick="App.nav('dashboard')" data-voice="Mở bảng điều khiển">Mở Dashboard</button>
        </div>
      </div>
    </div>

    <div class="section">
      <div class="row">
        <div class="level-pill">Gợi ý cấp độ đọc tiếp theo: <b id="nextLevelHint">—</b></div>
        <div class="spacer"></div>
        <button onclick="App.nav('export')" data-voice="Xuất dữ liệu">Xuất dữ liệu</button>
      </div>
    </div>
  </section>

  <!-- PA -->
  <section id="screen-pa" class="screen">
    <div class="row">
      <button onclick="App.nav('home')" data-voice="Về trang chính">← Về trang chính</button>
      <div class="spacer"></div>
      <span class="badge">Âm vị học</span>
    </div>
    <div class="section" id="pa-container"></div>
    <div class="help">Mẹo: Nhấn “🔊” để nghe mẫu; kéo‑thả “hạt âm/tiếng” để ráp từ; hoặc chọn thanh điệu/cặp tối thiểu theo yêu cầu.</div>
  </section>

  <!-- Cards -->
  <section id="screen-cards" class="screen">
    <div class="row">
      <button onclick="App.nav('home')" data-voice="Về trang chính">← Về trang chính</button>
      <div class="spacer"></div>
      <span class="badge">Thẻ từ</span>
    </div>
    <div class="section" id="cards-container"></div>
    <div class="help">Đánh giá “Dễ/Vừa/Khó” để ứng dụng tự động hẹn ngày ôn.</div>
  </section>

  <!-- Reading -->
  <section id="screen-reading" class="screen">
    <div class="row">
      <button onclick="App.nav('home')" data-voice="Về trang chính">← Về trang chính</button>
      <div class="spacer"></div>
      <span class="badge">Đọc đoạn</span>
    </div>

    <div class="section">
      <div class="row">
        <label for="selLevel" style="margin:0;">Cấp độ:</label>
        <select id="selLevel" onchange="App.reading.chooseLevel(this.value)" aria-label="Chọn cấp độ"></select>
        <div class="spacer"></div>
        <div class="slider" data-voice="Điều chỉnh tốc độ giọng đọc">
          <span>🔊 Tốc độ</span>
          <input id="rateSlider" type="range" min="0.6" max="1.4" step="0.05" value="0.9"
                 oninput="App.updateRateFromSlider(this.value)"
                 onfocus="VoiceUI.speak('Thanh tốc độ giọng đọc')" />
          <span id="rateVal">0.90x</span>
        </div>
        <button class="ghost" onclick="App.reading.toggleFocus()" id="btnFocus" data-voice="Bật tắt chế độ một dòng">Chế độ 1 dòng: Tắt</button>
      </div>
    </div>

    <div class="section">
      <div class="row">
        <button class="primary" id="btnStartRead" onclick="App.reading.start()" data-voice="Bắt đầu đọc và tính giờ">Bắt đầu đọc</button>
        <button id="btnStopRead" class="danger" onclick="App.reading.stop()" disabled data-voice="Kết thúc bài đọc">Kết thúc</button>
        <button class="tts" onclick="App.reading.speakPassage()" data-voice="Nghe toàn bộ đoạn">🔊 Nghe đoạn</button>
        <button class="record" id="btnRec" onclick="App.reading.toggleRec()" data-voice="Ghi âm giọng đọc hoặc nghe lại">Ghi âm</button>
        <span class="stat">⏱️ <span id="timer">00:00</span></span>
        <span class="stat">WCPM: <b id="statWCPM">—</b></span>
        <span class="stat">% đúng: <b id="statAcc">—</b></span>
      </div>
    </div>

    <div class="section">
      <div id="passageView" class="big-text"></div>
      <div class="inline-buttons">
        <button class="hint" onclick="App.reading.markMode('error')" id="btnErr" data-voice="Chế độ đánh dấu lỗi">Đánh dấu lỗi</button>
        <button class="ghost" onclick="App.reading.markMode('normal')" id="btnNorm" data-voice="Chế độ bình thường">Chế độ bình thường</button>
      </div>
      <div class="help">Chạm vào từ để đánh dấu lỗi; chạm lại để bỏ. Nhấn và giữ để chọn loại lỗi. Chạm vào từ để nghe lại phát âm.</div>
    </div>

    <div id="compSection" class="section" style="display:none;">
      <h3>Câu hỏi hiểu nội dung</h3>
      <div id="questions"></div>
      <div class="row" style="margin-top:8px;">
        <div class="spacer"></div>
        <button class="primary" onclick="App.reading.finishComp()" data-voice="Hoàn tất câu hỏi">Hoàn tất</button>
      </div>
    </div>
  </section>

  <!-- Dashboard -->
  <section id="screen-dashboard" class="screen">
    <div class="row">
      <button onclick="App.nav('home')" data-voice="Về trang chính">← Về trang chính</button>
      <div class="spacer"></div>
      <span class="badge">Dashboard</span>
    </div>

    <div class="grid-2">
      <div class="section">
        <h3>WCPM theo thời gian</h3>
        <canvas id="chartWCPM" width="600" height="260"></canvas>
      </div>
      <div class="section">
        <h3>% chính xác theo thời gian</h3>
        <canvas id="chartACC" width="600" height="260"></canvas>
      </div>
      <div class="section">
        <h3>Tổng lỗi theo loại</h3>
        <canvas id="chartERR" width="600" height="260"></canvas>
      </div>
      <div class="section">
        <h3>Thời lượng luyện tập</h3>
        <canvas id="chartDUR" width="600" height="260"></canvas>
      </div>
    </div>

    <div class="section">
      <div class="row">
        <button onclick="App.exportCSV()" data-voice="Tải tệp CSV">Tải CSV</button>
        <button class="ghost" onclick="App.copyCSV()" data-voice="Sao chép CSV">Sao chép CSV</button>
        <div class="spacer"></div>
        <button class="danger" onclick="App.resetConfirm()" data-voice="Xóa dữ liệu trên thiết bị này">Xóa dữ liệu (thiết bị này)</button>
      </div>
      <div class="help">CSV mở bằng Excel/Google Sheets. Dữ liệu chỉ lưu trên thiết bị này trừ khi bạn bật Đồng bộ.</div>
    </div>

    <div class="section">
      <h3>Đồng bộ Google Drive</h3>
      <div class="row">
        <div class="spacer"></div>
        <span class="badge" id="syncStatus">Trạng thái: chưa cấu hình</span>
      </div>
      <div class="inline-buttons" style="margin-top:10px;">
        <button onclick="Sync.flush()" data-voice="Đồng bộ dữ liệu ngay">Đồng bộ ngay</button>
        <button class="ghost" onclick="App.testSync()" data-voice="Kiểm tra kết nối đồng bộ">Kiểm tra kết nối</button>
        <button class="ghost" onclick="App.showSyncHelp()" data-voice="Hướng dẫn thiết lập đồng bộ">Hướng dẫn thiết lập</button>
      </div>
      <div class="help">Ứng dụng gửi log đọc (WCPM, % đúng, lỗi, hiểu) tới Apps Script, rồi lưu vào Google Drive của bạn.</div>
    </div>
  </section>

  <!-- Export -->
  <section id="screen-export" class="screen">
    <div class="row">
      <button onclick="App.nav('home')" data-voice="Về trang chính">← Về trang chính</button>
      <div class="spacer"></div>
      <span class="badge">Xuất dữ liệu</span>
    </div>
    <div class="section">
      <div class="row">
        <button onclick="App.exportCSV()" data-voice="Tải tệp CSV">Tải CSV</button>
        <button class="ghost" onclick="App.copyCSV()" data-voice="Sao chép CSV">Sao chép CSV</button>
      </div>
      <div class="help">Dán vào Google Sheets để theo dõi dài hạn.</div>
    </div>
  </section>

  <!-- Settings -->
  <section id="screen-settings" class="screen">
    <div class="row">
      <button onclick="App.nav('home')" data-voice="Về trang chính">← Về trang chính</button>
      <div class="spacer"></div>
      <span class="badge">Cài đặt</span>
    </div>

    <div class="section">
      <div class="grid-2">
        <div>
          <label>Mã học viên (không dùng tên thật)</label>
          <input type="text" id="inpId" placeholder="VD: HS001" />
        </div>
        <div>
          <label>Tuổi</label>
          <input type="number" id="inpAge" min="5" max="15" />
        </div>
        <div>
          <label>Khối/lớp</label>
          <input type="text" id="inpGrade" placeholder="VD: Lớp 2" />
        </div>
        <div>
          <label>Phông chữ</label>
          <select id="selFont">
            <option>Lexend</option>
            <option>OpenDyslexic</option>
            <option selected>System Sans</option>
          </select>
        </div>
        <div>
          <label>Tốc độ TTS (0.6–1.4)</label>
          <input type="number" id="inpRate" value="0.9" step="0.05" min="0.6" max="1.4" />
        </div>
        <div>
          <label>Cấp độ đọc ban đầu</label>
          <select id="selStartLevel"></select>
        </div>
      </div>
      <div class="row" style="margin-top:10px;">
        <button class="primary" onclick="App.saveSettings()" data-voice="Lưu cài đặt">Lưu</button>
      </div>
      <div class="help">“System Sans” tương thích mọi máy. Nếu máy có Lexend/OpenDyslexic, ứng dụng sẽ ưu tiên dùng.</div>
    </div>

    <div class="section">
      <h3>Đồng bộ Google Drive</h3>
      <div class="grid-2">
        <div>
          <label>Đồng bộ (Apps Script URL)</label>
          <input type="url" id="inpSyncUrl" placeholder="https://script.google.com/macros/s/XXX/exec" />
        </div>
        <div>
          <label>Mật mã bí mật (SECRET)</label>
          <input type="text" id="inpSyncSecret" placeholder="docde-secret-2025" />
        </div>
      </div>
      <div class="row" style="margin-top:10px;">
        <button onclick="App.saveSync()" data-voice="Lưu cài đặt đồng bộ">Lưu đồng bộ</button>
        <button class="ghost" onclick="App.testSync()" data-voice="Kiểm tra kết nối đồng bộ">Kiểm tra kết nối</button>
      </div>
      <div class="help">Sao chép URL Web App từ Google Apps Script (Execute as: Me, Access: Anyone). SECRET phải trùng trong Script.</div>
    </div>
  </section>

  <!-- Help -->
  <div id="modalHelp" class="modal">
    <div class="dialog">
      <h3>Hướng dẫn nhanh</h3>
      <ul>
        <li>Âm vị: 5–7 phút, 6–8 mục tiêu theo lỗi hay gặp.</li>
        <li>Thẻ từ: 5 phút, 10–15 thẻ (Dễ/Vừa/Khó).</li>
        <li>Đọc đoạn: 3 lần/đoạn, đo WCPM & % đúng; làm 2–3 câu hỏi hiểu.</li>
        <li>Giọng nói trợ giúp: Nhấn giữ 0.4 giây lên nút để nghe tên trước khi bấm.</li>
      </ul>
      <div class="row">
        <div class="spacer"></div>
        <button onclick="document.getElementById('modalHelp').classList.remove('active')" data-voice="Đóng hướng dẫn">Đã hiểu</button>
      </div>
    </div>
  </div>

  <!-- Onboarding -->
  <div id="modalOnboard" class="modal">
    <div class="dialog">
      <h3>Thiết lập nhanh</h3>
      <div class="grid-2">
        <div>
          <label>Mã học viên</label>
          <input type="text" id="obId" placeholder="VD: HS001"/>
        </div>
        <div>
          <label>Tuổi</label>
          <input type="number" id="obAge" min="5" max="15"/>
        </div>
        <div>
          <label>Khối/lớp</label>
          <input type="text" id="obGrade" placeholder="VD: Lớp 2"/>
        </div>
      </div>
      <div class="row" style="margin-top:10px;">
        <button class="primary" onclick="App.finishOnboard()" data-voice="Bắt đầu sử dụng">Bắt đầu</button>
      </div>
      <div class="help">Dữ liệu ẩn danh, chỉ lưu cục bộ nếu bạn chưa bật Đồng bộ.</div>
    </div>
  </div>

  <!-- Chọn loại lỗi -->
  <div id="errorMenu" class="modal" style="background: transparent;">
    <div class="dialog" style="max-width:380px;">
      <h3>Chọn loại lỗi</h3>
      <div class="row" style="flex-wrap: wrap;">
        <button onclick="App.reading.setErrType('tone')" data-voice="Sai thanh điệu">Sai thanh điệu</button>
        <button onclick="App.reading.setErrType('sx')" data-voice="Nhầm s và x">Nhầm s x</button>
        <button onclick="App.reading.setErrType('chtr')" data-voice="Nhầm ch và tr">Nhầm ch tr</button>
        <button onclick="App.reading.setErrType('omission')" data-voice="Bỏ âm hoặc bỏ từ">Bỏ âm</button>
        <button onclick="App.reading.setErrType('insertion')" data-voice="Thêm âm hoặc thêm từ">Thêm âm</button>
        <button onclick="App.reading.setErrType('other')" data-voice="Lỗi khác">Khác</button>
      </div>
      <div class="row" style="margin-top:8px;">
        <div class="spacer"></div>
        <button class="ghost" onclick="document.getElementById('errorMenu').classList.remove('active')" data-voice="Đóng bảng chọn lỗi">Đóng</button>
      </div>
    </div>
  </div>

  <!-- Khoá/thoát Child Mode -->
  <div class="lockbar" id="lockbar" style="display:none;">
    <span>🚸 Tự học đang bật</span>
    <button class="ghost" id="btnUnlock" data-voice="Giữ ba giây để thoát tự học">Giữ 3s để thoát</button>
  </div>

</div>

<div class="footerbar">
  <button onclick="App.nav('home')" data-voice="Trang chính">Trang chính</button>
  <button onclick="App.nav('pa')" data-voice="Âm vị">Âm vị</button>
  <button onclick="App.nav('cards')" data-voice="Thẻ từ">Thẻ từ</button>
  <button onclick="App.nav('reading')" data-voice="Đọc đoạn">Đọc đoạn</button>
  <button onclick="App.nav('dashboard')" data-voice="Bảng điều khiển">Dashboard</button>
</div>

<!-- Scripts: tách nhỏ theo trách nhiệm -->
<script src="app/data.js"></script>
<script src="app/store.js"></script>
<script src="app/tts.js"></script>
<script src="app/voiceui.js"></script>
<script src="app/recorder.js"></script>
<script src="app/coach.js"></script>
<script src="app/utils.js"></script>
<script src="app/charts.js"></script>
<script src="app/adaptive.js"></script>
<script src="app/sr.js"></script>
<script src="app/sync.js"></script>

<script src="app/modules/pa.js"></script>
<script src="app/modules/cards.js"></script>
<script src="app/modules/reading.js"></script>
<script src="app/modules/dashboard.js"></script>

<script src="app/app.js"></script>
</body>
</html>